<!DOCTYPE html>
<html lang="ru">

  <head>
    <title>Настройка выделенного сервера Source под Linux, часть 1 &#x2F; Хабр</title>

































    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
  </head>
  <body>
    
    <div id="mount"><div id="app"><div class="tm-layout__wrapper"><!--[--><!----><div></div><div class="header-banner-wrapper"><div class="element-wrapper above-header" style="--754c4550:100%;--56cb6579:auto;"><!--[--><div class="placeholder-wrapper banner-container__placeholder"><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><div class="adfox-banner-placeholder above-header" data-v-24012b5e><div class="image loads" data-v-24012b5e></div><div class="lines" data-v-24012b5e><div class="line loads" data-v-24012b5e></div><div class="line loads" data-v-24012b5e></div><div class="line loads" data-v-24012b5e></div></div></div><!----><!----><!----></div><!--[--><div id="adfox_175449164307199013_aboveHeader" class="banner-target"></div><!--]--><!--]--></div></div><header class="tm-header tm-header" data-test-id="header"><!----><!----><div class="tm-page-width"><!--[--><div class="tm-header__container"><button aria-expanded="false" aria-label="Toggle menu" class="burger-button tm-header__button tm-header__burger" data-v-56ed7aae><span class="line top" data-v-56ed7aae></span><span class="line middle" data-v-56ed7aae></span><span class="line bottom" data-v-56ed7aae></span></button><span class="tm-header__logo-wrap"><a class="tm-header__logo tm-header__logo_hl-ru tm-header__logo" href="/ru/feed"><svg class="tm-svg-img tm-header__icon" height="16" width="16"><title>Хабр</title><use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a></span><span class="tm-header__divider"></span><!--[--><a class="tm-header__all-flows" href="/ru/articles/">Все потоки</a><!--]--><!----><div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search" data-test-id="search-button"><svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search" height="24" width="24"><title>Поиск</title><use xlink:href="/img/megazord-v28.cba4c116..svg#search"></use></svg></a><!----><!----><div class="tm-header-user-menu__item tm-header-user-menu__write"><a href="/ru/sandbox/start/" class=""><svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_write" height="24" width="24"><title>Написать публикацию</title><use xlink:href="/img/megazord-v28.cba4c116..svg#write"></use></svg></a><!----></div><!--[--><div class="tm-header-user-menu__item"><button class="tm-header-user-menu__toggle" data-test-id="user-menu-settings"><svg class="tm-svg-img tm-header-user-menu__icon" height="24" width="24"><title>Настройки</title><use xlink:href="/img/megazord-v28.cba4c116..svg#page-settings"></use></svg></button></div><a href="https://habr.com/kek/v1/auth/habrahabr/?back=/ru/articles/312922/&amp;hl=ru" rel="nofollow" class="tm-header-user-menu__item tm-header-user-menu__login" role="button"><!--[-->Войти<!--]--></a><!--]--><template><!----></template><!--teleport start--><!--teleport end--></div></div><!--]--></div></header><div class="tm-layout"><div class="tm-page-progress-bar"></div><!----><div class="tm-page-width"><!--[--><!----><!----><!----><!--]--></div><main class="tm-layout__container"><div class="tm-page" hl="ru" data-async-called="true" style="--a414e232:300px;--10c4682a:0;--19620736:0;"><!----><div class="tm-page-width"><!--[--><!----><div class="tm-page__wrapper"><!----><div class="tm-page__main_has-sidebar tm-page__main"><div class="pull-down"><!----><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg class="tm-svg-img pull-down__icon pull-down__arrow" height="24" width="24"><title>Обновить</title><use xlink:href="/img/megazord-v28.cba4c116..svg#pull-arrow"></use></svg></div></div><!--[--><div><!--[--><!----><div class="tm-article-presenter" data-async-called="true"><!--[--><!--]--><div class="tm-article-presenter__body" data-test-id="article-body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><!--[--><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><!--[--><div class="tm-article-presenter__header"><!--[--><!--]--><div class="article-snippet tm-article-presenter__snippet" data-v-085cd854><!--[--><!--]--><div class="meta-container" data-v-085cd854><div class="meta" data-v-085cd854><span class="tm-user-info author" data-v-085cd854><a href="/ru/users/abrca/" class="tm-user-info__userpic" data-test-id="user-info-pic"><!--[--><div class="tm-entity-image"><!--[--><!--]--></div><!--]--></a><span class="tm-user-info__user tm-user-info__user_appearance-default" data-test-id="user-info-description"><a href="/ru/users/abrca/" class="tm-user-info__username" data-test-id="user-info-username"><!--[-->abrca<!--]--></a><!----><!--[--><span class="tm-article-datetime-published" data-v-085cd854><time data-allow-mismatch datetime="2016-10-17T15:41:57.000Z" title="2016-10-17, 15:41">17  окт  2016 в 15:41</time></span><!--]--></span></span></div><div class="controls" data-v-085cd854><!----><!----><!----><!----></div></div><h1 class="tm-title tm-title_h1" lang="ru" data-test-id="articleTitle" data-v-085cd854><span>Настройка выделенного сервера Source под Linux, часть 1</span></h1><div class="stats" data-test-id="articleStats" data-v-085cd854><!----><div class="tm-article-reading-time" data-v-085cd854><span class="tm-svg-icon__wrapper tm-article-reading-time__icon"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Время на прочтение</title><use xlink:href="/img/megazord-v28.cba4c116..svg#clock"></use></svg></span><span class="tm-article-reading-time__label">31 мин</span></div><span class="tm-icon-counter tm-data-icons__item reach-counter" data-v-085cd854><svg class="tm-svg-img tm-icon-counter__icon" height="24" width="24"><title>Охват и читатели</title><use xlink:href="/img/megazord-v28.cba4c116..svg#counter-views"></use></svg><span class="tm-icon-counter__value" title="16855">17K</span></span></div><div class="tm-publication-hubs__container" data-test-id="articleHubsList" data-v-085cd854><div class="tm-publication-hubs"><!--[--><span class="tm-publication-hub__link-container"><a href="/ru/hubs/nix/" class="tm-publication-hub__link"><!--[--><span>*nix</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб"> * </span><!--]--></a></span><!--]--></div></div><div class="tm-article-labels" data-test-id="articleLabels" data-v-085cd854 data-v-bfa2437b><div class="tm-article-labels__container" data-v-bfa2437b><!----><!--[--><div class="tm-publication-label tm-publication-label_variant-tutorial" data-v-bfa2437b><span>Туториал</span></div><!--[--><!--]--><!--]--></div></div><!----><!----><!--teleport start--><!--teleport end--></div></div><!--[--><!----><div class="article-body" data-gallery-root lang="ru" data-v-aad06d04><div data-v-aad06d04><!--[--><!--]--></div><div id="post-content-body" data-v-aad06d04><div><div class="article-formatted-body article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><p>В данном руководстве будет описана установка и настройка одновременной работы нескольких выделенных игровых серверов Steam под Linux на примере игры Team Fortress 2.</p><br/>
<ul>
<li>Введение</li>
<li>Установка клиента Steam и сервера Team Fortress 2</li>
<li>Базовая настройка серверов<br/>
<ul>
<li>Теория</li>
<li>Практика</li>
<li>Сетевые настройки</li>
<li>Скрипты запуска сервера</li>
</ul></li>
<li>Обновление серверов<br/>
<ul>
<li>Автоматическое</li>
<li>Периодическое обновление</li>
<li>Только проверка<a name="habracut"></a></li>
</ul></li>
</ul><br/>
<h1 id="vvedenie">Введение</h1><br/>
<p>Нам понадобится:</p><br/>
<ul>
<li>сервер с процессором, диском и памятью, способными потянуть все игровые сервера</li>
<li>нормальный канал в интернет. Не dialup. Не ADSL.</li>
<li>установленный веб-сервер, в нашем случае — nginx</li>
<li>установленный sql-сервер, в нашем случае — mysql (mariadb)</li>
<li>возможность запускать задачи по расписанию (cron)</li>
<li>php с модулями</li>
<li>root доступ на отдельных этапах настройки</li>
<li>достаточно места на диске для:<br/>
<ul>
<li>игрового сервера — свыше шести гигабайт</li>
<li>логов (а их будет много и разных)</li>
<li>записей (replay)</li>
<li>sql баз данных</li>
<li>пользовательских карт, звуков, моделей и так далее.</li>
</ul></li>
</ul><br/>
<p>Всё нижеследующее описывается применительно к отдельному серверу, физическому или виртуальному, с установленным и настроенным Linux, доступом в консоль. Во всех примерах у сервера ip адрес 192.0.2.0, у нашего клиентского компьютера 198.51.100.0</p><br/>
<p>Игровому серверу для запуска и работы не нужны root полномочия, поэтому устанавливать и запускать всё будем из-под непривилегированного пользователя game. Заходим как root и добавляем пользователя:</p><br/>
<pre><code class="dos">   # useradd --user-group --create-home --comment "Source dedicated server" game</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Поскольку мы будем запускать ряд скриптов по расписанию, то проверим, может ли пользователь game создавать свой crontab файл:</p><br/>
<pre><code class="dos">   # su - game
   $ crontab -e</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Если открылось окно редактора, то хорошо, может. Если же на экран вывелось что-то вида:</p><br/>
<pre><code>   cannot chdir(/var/spool/cron), bailing out.
   /var/spool/cron: Permission denied</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>то не может. Тогда, в зависимости от используемой программы cron и её настроек, разрешаем пользователю (предварительно выйдя из-под game назад в root) создавать свой crontab файл.</p><br/>
<p>Итак, пользователь создан, авторизация настроена. Закрываем root сессию, продолжаем работать как game.</p><br/>
<h1 id="ustanovka-klienta-steam-i-servera-team-fortress-2">Установка клиента Steam и сервера Team Fortress 2</h1><br/>
<p>Нашу цель по установке и настройке одновременной работы нескольких игровых серверов можно достичь разными способами. В простейшем случае — создавая отдельные экземпляры серверов, каждый в своём каталоге. Это, ценой неэффективного использования дискового пространства (если файловая система или хранилище данных не используют дедупликацию) и повышенного расхода траффика на скачивание одинаковых обновлений даёт возможность независимой настройки, обновления и управления серверами, хотя при использовании одного ip адреса всеми игровыми серверами всё же придётся им использовать разные порты. Другой способ — использование единого каталога для игры, но с индивидуальными настройками игровых серверов. Этим путём мы и пойдём.</p><br/>
<p>Если у нас 64-битный дистрибутив Linux, то необходимо установить дополнительные библиотеки совместимости (из-под пользователя root). Какие именно — гуглится по фразе <a href="https://www.google.com/?q=steamcmd+x64">steamcmd x64 ВАШ_ДИСТРИБУТИВ</a>. Для Ubuntu 13.10 x64, например, <code>apt-get install lib32gcc1</code>, для ArchLinux — <code>pacman -S lib32-gcc-libs</code> (при включённом репозитории multilib в /etc/pacman.conf), для CentOS — <code>yum install glibc.i686 libstdc++.i686</code> и так далее.</p><br/>
<p>Если их не устанавливать, будут выдаваться ошибка вида:</p><br/>
<pre><code>   ./steamcmd.sh: line 29: /home/game/Steam/linux32/steamcmd: No such file or directory</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>либо</p><br/>
<pre><code>   ./steamcmd.sh: /home/game/Steam/linux32/steamcmd: /lib/ld-linux.so.2: bad ELF interpreter: No such file or directory</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Устанавливать клиента Steam будем в одноимённый каталог в домашней директории пользователя game, а саму игру в каталог tf2. Предполагается, что в /etc/fstab раздел с /home монтируется без noexec и там достаточно свободного места.</p><br/>
<p>Создаём каталоги для наших серверов и переходим в первый:</p><br/>
<pre><code class="bash">   $ mkdir ~/Steam
   $ mkdir ~/tf2
   $ cd ~/Steam</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Скачиваем <a href="https://developer.valvesoftware.com/wiki/SteamCMD">консольный клиент Steam</a>, распаковываем архив.</p><br/>
<pre><code class="bash">   $ wget http://media.steampowered.com/client/steamcmd_linux.tar.gz
   $ tar -xvzf steamcmd_linux.tar.gz</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Для большей наглядности разобьём следующий запуск steamcmd.sh на два. Сначала запустим процедуру самообновления:</p><br/>
<pre><code class="bash">   $ ./steamcmd.sh +quit</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Клиент Steam должен обновиться. В случае каких-то проблем читаем логи в ~/Steam/logs.</p><br/>
<p>Теперь установим выделенный сервер игры:</p><br/>
<pre><code class="bash">   $ ./steamcmd.sh +login anonymous +force_install_dir ~/tf2/ +app_update 232250 validate +quit</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Число "232250" в параметрах командной строки — это appid, идентификатор приложения, в нашем случае Team Fortress 2 dedicated server. Подробнее команды описаны в разделе "Обновление серверов".</p><br/>
<p>Если всё ok, то бодренько начнётся загрузка:</p><br/>
<pre><code>   Redirecting stderr to '/home/game/Steam/logs/stderr.txt'
   ...
   Connecting anonymously to Steam Public...Logged in OK
   Waiting for license info...OK
    Update state (0x3) reconfiguring, progress: 0.00 (0 / 0)
    Update state (0x11) preallocating, progress: 8.28 (561715882 / 6785978023)
    Update state (0x61) downloading, progress: 0.20 (13671159 / 6785978023)
    Update state (0x61) downloading, progress: 0.70 (47497460 / 6785978023)
    ...
    Update state (0x61) downloading, progress: 99.96 (6783415033 / 6785978023)
    Update state (0x81) committing, progress: 7.66 (519615292 / 6785978023)
   Success! App '232250' fully installed.</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Несколько минут, и у нас для Team Fortress 2 будет скачано шесть с половиной гигабайт (по состоянию на октябрь 2016 г.).</p><br/>
<p>Переходим в папку ~/tf2 и пробуем запустить игру вручную, посмотрим, как оно.</p><br/>
<pre><code class="bash">   $ cd ~/tf2
   $ ./srcds_run -game tf +map cp_cloak</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>На консоли должно появится что-то вроде:</p><br/>
<pre><code>   Auto detecting CPU
   Using default binary: ./srcds_linux
   Server will auto-restart if there is a crash.

   WARNING: Failed to load 32-bit libtinfo.so.5 or libncurses.so.5.
     Please install (lib32tinfo5 / ncurses-libs.i686 / equivalent) to enable readline.

   Using Breakpad minidump system. Version: 3475087 AppID: 232250
   Setting breakpad minidump AppID = 232250
   Using breakpad crash handler
   Loaded 7510 VPK file hashes from /home/game/tf2/tf/tf2_textures.vpk for pure server operation.
   ...
   Network: IP 192.0.2.0, mode MP, dedicated Yes, ports 27015 SV / 27005 CL
   Initializing Steam libraries for secure Internet server
   ...
   Connection to Steam servers successful.
      Public IP is 192.0.2.0.
   Assigned anonymous gameserver Steam ID [A:1:1724597452:5521].
   VAC secure mode is activated.
   Received 3825164 bytes item schema version DBDD1115 direct data; update is queued.</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Можно уважить просьбу, установив библиотеку ncurses-libs.i686. А в остальном всё хорошо. Убедимся, что в строках 13 (Network: ...) и 17 (Public IP ...) сервер выбрал правильный IP.</p><br/>
<p>На ошибки про "/home/game/.steam/sdk32/steamclient.so: cannot open shared object file: No such file or directory" не обращаем внимания, это нормально. Впрочем, можно и поправить:</p><br/>
<pre><code class="bash">   $ mkdir -p ~/.steam/sdk32
   $ ln -s ~/Steam/linux32/steamclient.so ~/.steam/sdk32</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Запускаем у себя на компьютере Team Fortress 2, вызываем консоль (<code>~</code>), затем <code>connect 192.0.2.0:27015</code> (Либо сразу steam://connect/192.0.2.0:27015 — можно потом создать ярлык на рабочем столе). Начинаем подключаться к игровому серверу, а на консоли сервера в это время вывелась строчка вида</p><br/>
<pre><code>   Client "Ich" connected (198.51.100.0:42380).</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Если подключиться не получилось, то проверяем, на правильном ли интерфейсе "слушает" сервер. При наличии файервола проверяем, открыты ли нужные порты согласно <a href="https://support.steampowered.com/kb_article.php?ref=8571-GLVN-8711">руководства Valve</a>. В случае более сложных сетевых конфигураций (сервер за NAT и тому подобное) обращаемся к соответствующим руководствам.</p><br/>
<p>Останавливаем игровой сервер командой <code>quit</code>, впечатав её в его консоль, возвращаемся в командную строку и начинаем настройку.</p><br/>
<h1 id="bazovaya-nastroyka-serverov">Базовая настройка серверов</h1><br/>
<h2 id="teoriya">Теория</h2><br/>
<p>Исторически, за годы развития, сложились различные возможности по конфигурированию сервера.</p><br/>
<p>По умолчанию сервер использует несколько основных файлов с настройками, которые ищет в ~/tf2/tf/cfg/: autoexec.cfg — выполняется единожды при старте сервера, server.cfg — при запуске любой карты, &lt;имя_карты&gt;.cfg — при запуске соответствующей карты.</p><br/>
<p>Так же, при запуске сервера, в его командной строке можно указать параметр <code>+servercfgfile my.cfg</code> — при этом сервер отныне будет использовать не server.cfg а my.cfg, и несколько параметров вида <code>+exec file1.cfg +exec file2.cfg +exec file3.cfg</code> — эти файлы будет выполнены единожды при старте сервера, сразу после autoexec.cfg.</p><br/>
<p>Вдобавок, ещё до проверки основного каталога, сервер при запуске ищет в ~/tf2/tf/custom файлы с расширением .vpk и структуры каталогов вида my_dir/cfg/, my_dir/maps/, my_dir/materials/ и тому подобное и найденные там файлы использует вместо одноимённых стандартных.</p><br/>
<p>Но и это не всё. В обновлении Team Fortress 2 от <a href="http://wiki.teamfortress.com/wiki/May_14,_2013_Patch">14 мая 2013 года</a> появился новый параметр командной строки <code>-insert_search_path</code>. Он служит для добавления пользовательской структуры каталогов (аналогично custom/), но с возможностью указания абсолютного пути, то есть не обязательно внутри серверного каталога ~/tf2/tf/. Раньше для это приходилось исхитряться, а сейчас достаточно в командной строке srcds_run указать -insert_search_path /var/dir1 и этот каталог будет использоваться как поисковый путь (/var/dir1/maps, /var/dir1/cfg, ...) до путей в custom/ и до основного каталога с файлами конфигураций ~/tf2/tf/cfg/. В -insert_search_path можно указать несколько каталогов через запятую. Причём каталоги будут обрабатываться в том порядке, в каком они перечислены, в отличие от структуры каталогов в custom/, где они обрабатываются по алфавиту.</p><br/>
<p>То есть, если у нас есть несколько файлов server.cfg в разных каталогах:</p><br/>
<pre><code>   ~/tf2/tf/cfg/server.cfg
   ~/tf2/tf/custom/my_files/cfg/server.cfg
   ~/tf2/tf/custom/another/cfg/server.cfg
   /var/dir1/cfg/server.cfg</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>и в командной строке сервера мы вдобавок укажем <code>-insert_search_path /var/dir1</code>, то при запуске сервера и выполнении в консоли и скриптах команд вида <code>exec server.cfg</code>, этот файл сначала будет искаться в /var/dir1/cfg, затем в custom/another/cfg/, далее в custom/my_files/cfg/ (каталоги в custom/ перебираются по алфавиту) и напоследок в основном cfg/. Это относится не только к server.cfg, но и к motd.txt, картам и пр. Подробнее про поисковые пути можно почитать (и поковырять настройки) в ~/tf2/tf/gameinfo.txt — там есть и про настройки путей в зависимости от системного языка, не освещённые здесь и много всего интересного.</p><br/>
<p>Посмотреть очерёдность перебора поисковых путей очень просто — достаточно в консоли запущенного сервера ввести команду <code>path</code>:</p><br/>
<pre><code>   path
   ---------------
   Paths:
   "maps/cp_cloak.bsp" "GAME" (map)
   "/home/game/tf2/bin/" "EXECUTABLE_PATH"
   "/home/game/tf2/" "BASE_PATH"
   "/var/dir1/" "GAME"
   "/var/dir1/" "MOD"
   "/home/game/tf2/tf/custom/another/" "GAME"
   "/home/game/tf2/tf/custom/another/" "MOD"
   "/home/game/tf2/tf/custom/my_files/" "GAME"
   "/home/game/tf2/tf/custom/my_files/" "MOD"
   и так далеее, далее, далее</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Так же не забываем про файлы настроек вида &lt;имя карты&gt;.cfg. Кроме того есть replay.cfg, sourcemod.cfg, ммм… да тысячи их!</p><br/>
<p>Такой зоопарк позволяет при настройке индивидуальных конфигураций для серверов выстрелить себе в ногу разнообразными способами. А так как srcds — молодой, динамически развивающийся сервер, то он может доставить немало весёлых часов в поисках ответа на вопрос "А почему ВНЕЗАПНО у игроков перестали скачиваться пользовательские карты. Даже через slow download, не говоря уж о fast… Два года всё было нормально..."</p><br/>
<p>Из всего предложенного богатства выбора, мы остановимся на указании файлов конфигурации в +exec и +servercfgfile в параметрах запуска.</p><br/>
<p>Необходимо учитывать, что любые комплектные файлы, установленные при инсталляции в ~/tf2 могут быть изменены при очередном обновлении сервера, в том числе и файлы в ~/tf2/tf/cfg. Поэтому мы не будем напрямую задействовать имеющиеся файлы конфигурации, а станем создавать, пусть даже и на их основе, но свои.</p><br/>
<p>То есть вместо использования уже существующего, комплектного файла со списком карт для ротации, например, <code>+mapcyclefile mapcycle_quickplay_cp.txt</code>, пусть даже на данный момент он нас полностью устраивает, мы скопируем его в свой mapcycle.txt и будем подключать его.</p><br/>
<blockquote>Изменённые либо удалённые нами комплектные файлы (не только конфигурации, а любые) могут быть возвращены в своё исходное состояние путём запуска обновления игрового сервера с параметром "validate" — <code>steamcmd.sh +login anonymous +force_install_dir ~/tf2/ +app_update 232250 validate +quit</code>. Тогда, даже если как такового нового обновления для нас нет, будет осуществлена проверка контрольных сумм всех комплектных файлов, и, при несовпадении, изменённые файлы будут скачаны заново.</blockquote><br/>
<h2 id="praktika">Практика</h2><br/>
<p>В нашем примере мы будем настраивать два игровых сервера:</p><br/>
<ul>
<li>первый — публичный, с официальными картами, без модификаций.</li>
<li>второй — приватный, с пользовательскими картами, ботами, меняющими игровой процесс модификациями. Но с включённым Valve Anti-Cheat, конечно.</li>
</ul><br/>
<p>Создадим каталог для хранения файлов с настройками серверов. Заодно сделаем каталог для логов. На данный момент у нас уже есть логи клиента Steam, поэтому сразу же сделаем туда ссылку:</p><br/>
<pre><code class="bash">   $ mkdir ~/cfg
   $ mkdir ~/log
   $ ln -s ~/Steam/logs ~/log/steam</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Мы по возможности все файлы настроек будем создавать в ~/cfg и символьными ссылками раскладывать в соответствующие каталоги сервера. Такое размещение позволит заметно упростить процедуру резервного копирования и восстановления сервера, и уменьшить смешивание настроек разных серверов, хотя полностью избежать этого не удастся.</p><br/>
<p>Настройки можно условно сгруппировать в три категории:</p><br/>
<ol>
<li>Параметры, которые должны быть указаны только в командной строке запуска сервера. Пример — maxplayers и sv_pure при значении равном двум</li>
<li>Параметры, которые необходимо указывать до загрузки карт — либо в autoexec.cfg, либо в подключаемых в командной строке +exec file.cfg. Пример — mapcyclefile, motdfile, tv_enable, да много их</li>
<li>Все остальные, которые можно указывать в server.cfg и прочих файлах.</li>
</ol><br/>
<p>Но в командной строке сервера очень много не укажешь как из-за ограничения по максимальной длине, так и из соображений безопасности — при отсутствии должным образом закрученных гаек, другие пользователи на вашем Linux сервере с доступом в шелл могут видеть процессы и командные строки друг друга — <code>cat /proc/&lt;id&gt;/cmdline</code> с такими деликатными параметрами, как rcon_password, tf_server<em>identity</em>&lt;...&gt;, sv_setsteamaccount, sv_password и так далее.</p><br/>
<p>Таким образом мы для начала будем использовать всего-навсего пять файлов для наших настроек — общие настройки для обоих серверов в файле autoexec.cfg, индивидуальные настройки первого сервера — autoexec1.cfg и server1.cfg, второго — autoexec2.cfg и server2.cfg. Целесообразность разделения индивидуальных настроек по двум файлам диктуется как вышеприведённым делением параметров на три категории, так и необходимостью использования файлов (типа server.cfg), которые выполняются при каждой смене карты — для восстановления параметров, изменённых в индивидуальных файлах настроек карт, либо вручную в консоли, либо по cron'у, либо иным способом. Ведь файлы типа autoexec.cfg выполняются лишь при старте игрового сервера.</p><br/>
<blockquote>Нельзя не упомянуть три очень полезные команды. Первая — <code>echo "Какое-нибудь сообщение, выводимое на консоль сервера"</code>. При использовании в начале каждого файла конфигурации позволяет наглядно видеть очерёдность выполнения различных файлов, в случае анализа неочевидного поведения сервера. Вторая — <code>differences</code>, при вводе в консоли сервера показывает все переменные, значения которых отличны от значений по умолчанию. Облегчает поиск ответа на вопрос "Почему всё не так? Вроде всё как всегда...". Третья — <code>exec &lt;config&gt;</code> — позволяет вызывать одни файлы конфигурации из других. При вдумчивой настройке, да в сочетании с возможностью замены файлов по cron и вкупе с возможностью их запуска из скриптов (посредством tmux send-keys — пример в скрипте update.sh в разделе "Обновление серверов") позволяет превратить игровой сервер в живой организм, живущий собственной жизнью.</blockquote><p>Детальная настройка внутренней конфигурации игрового сервера здесь описываться не будет — у каждого она своя, остановимся лишь на моментах, связанных с одновременной работой двух серверов.</p><br/>
<p>Если у вас уже есть готовые файлы настроек для одинокого сервера, то можно начать с них, а если нет (ну, мало ли — наш первый игровой сервер), то можно погуглить по фразе <a href="https://www.google.com/?q=настройка+server.cfg+для+tf2">настройка server.cfg для tf2</a>. Единственно что могу посоветовать — не искать чей-нибудь максимально навороченный файл конфигурации десятилетней давности, в котором перечислены все возможные, в том числе и уже устаревшие параметры, причём подавляющее большинство — со значениями по умолчанию и описаниями, взятыми из cvarlist, а искать актуальные и максимально документированные описания, хотя это может быть непросто, да.</p><br/>
<p>Вообще, лучше начинать вовсе без готового server.cfg — игровой сервер прекрасно запустится и без него, мы в этом уже убедились, а вот когда захочется что-то поменять — количество и длительность раундов, автобалансировку команд и тому подобное — то тогда уже узнавать и прописывать параметры, которые этим управляют.</p><br/>
<p>Если всё же хочется узнать "все-все-все" серверные публичные команды и переменные, то в консоли запущенного сервера достаточно ввести:</p><br/>
<pre><code>   cvarlist log allcvars.txt
   cvar list
   --------------
   _resetgamestats    : cmd : : Erases current game stats and writes out a blank stats file
   _restart           : cmd : : Shutdown and restart the engine.
   ...
   --------------
   1908 total convars/concommands</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>и в файле ~/tf2/tf/allcvars.txt будут перечислены все консольные переменные, зачастую с краткими описаниями. Можно выводить только команды с определённым префиксом, например, <code>cvarlist tf_</code>, <code>cvarlist sv_</code>. Можно искать по подстроке — <code>find log</code>. При этом поиск выполняется как по имени, так и по описанию.</p><br/>
<p>Итак, создаём наши файлы конфигурации.</p><br/>
<blockquote>Стоит иметь в виду, что многие команды зависят друг от друга, и в ряде случаев важна их последовательность. Так, например, если сначала включить запись логов в файл (log on), а потом начать указывать в какой каталог (sv_logsdir) и под каким именем (sv_logfilename_format) — результаты будут не соответствовать ожиданиям.</blockquote><p>В файле ~/cfg/autoexec.cfg — он выполняется первым, прописываем настройки, общие для обоих серверов:</p><br/>
<div class="spoiler"><b class="spoiler_title">autoexec.cfg</b><div class="spoiler_text"><pre><code>// Сообщение на консоль сервера
echo "*** ~/cfg/autoexec.cfg (global)"

// Загрузка списков блокированных игроков, общие для всех серверов
exec banned_user.cfg
exec banned_ip.cfg
writeid
writeip

// Регион, где находится сервер
// -1 - мир, 0 - США восток, 1 - США запад, 2 - Южная Америка, 3 - Европа,
// 4 - Азия, 5 - Австралия, 6 - Ближний Восток, 7 - Африка
sv_region 3

// Настройки логов

// Можно писать логи только в один файл (1),
// либо при каждой смене карт создавать новый (0)
sv_log_onefile 0

// Записывать баны игроков в логи
sv_logbans 1

// Логи могут записываться в файл, выводиться в консоль, транслироваться по UDP.
// Разрешаем запись логов в файл
sv_logfile 1

// Дублировать логи в консоль
sv_logecho 0

// Включать запись логов (log on) мы будем в индивидуальных файлах
// наших серверов - после указания индивидуальных путей (sv_logsdir)</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<blockquote>Более подробно команды управления логами рассмотрены в разделе "Логи".</blockquote><p>Создадим (пока) пустые файлы banned_user.cfg и banned_ip.cfg</p><br/>
<pre><code class="bash">   $ touch ~/cfg/banned_user.cfg ~/cfg/banned_ip.cfg</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>В файле ~/cfg/autoexec1.cfg прописываем настройки для первого сервера:</p><br/>
<div class="spoiler"><b class="spoiler_title">autoexec1.cfg</b><div class="spoiler_text"><pre><code>// Сообщение на консоль сервера
echo "*** ~/cfg/autoexec1.cfg"

// Название сервера, как оно будет видно игрокам в браузере игровых серверов
hostname Public Server No 1

// Пароль для удалённой консоли.
// Понадобится для сервера статистики и удалённого управления
rcon_password rconPasswordServer1

// Начальная карта. Обязательно должна быть указана или здесь
// или в командной строке сервера. Командная строка приоритетнее
map cp_granary

// sv_allow_point_servercommand

// Файлы с message of the day
motdfile motd1.html
motdfile_text motd1.txt

// Файл с именами карт для ротации
mapcyclefile mapcycle1.txt

// Каталог для логов первого сервера
sv_logsdir /home/game/log/server1

// Включаем ведение логов
log on</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Про файлы motd и mapcyclefile будет сказано чуть ниже. Каталог для логов сервер создаст сам.</p><br/>
<p>А на второй сервер мы установим карту cp_orange_x3, не входящую в стандартную поставку Team Fortress 2. Простейший способ установки пользовательских карт — это положить файл с картой в ~/tf2/tf/maps, либо в каталог в одном из поисковых путей. Но есть ещё способ подключения сторонних карт. Если такая карта представлена в <a href="https://steamcommunity.com/app/440/workshop/">Steam Workshop</a>, то мы можем ссылаться на неё как на "workshop/", либо "workshop/&lt;имя карты&gt;.ugc" и в команде map и в файле mapcycle. Тогда при запуске игры наш сервер скачает её с серверов Valve, а при подключении игрока, его компьютер сам скачает карту оттуда же. При каждой смене карты, она будет проверяться на наличие обновлений. При использовании нестандартных карт только из Steam Workshop, становится ненужным включение Fast Download. Но обратная сторона медали — появляется зависимость ещё и от Workshop серверов.<br/>
<p>Итак, открываем в браузере Steam Workshop по ссылке выше, в строке поиска вводим "cp_orange_x3", в результатах поиска переходим на страницу карты — <a href="https://steamcommunity.com/sharedfiles/filedetails/?id=454299390">https://steamcommunity.com/sharedfiles/filedetails/?id=454299390</a>. Из этого url берём числовой id и прописываем его в нашем autoexec2.cfg в формате "workshop/454299390" либо "workshop/cp_orange_x3.ugc454299390". Второй вариант нагляднее.</p><br/>
<p>В файле ~/cfg/autoexec2.cfg прописываем настройки для второго сервера:</p><br/>
<div class="spoiler"><b class="spoiler_title">autoexec2.cfg</b><div class="spoiler_text"><pre><code>echo "*** ~/cfg/autoexec2.cfg"

hostname Private Server No 2

rcon_password rconPasswordServer2

//map workshop/454299390
map workshop/cp_orange_x3.ugc454299390

sv_allow_point_servercommand always

motdfile "motd2.txt"

mapcyclefile "mapcycle2.txt"

sv_logsdir /home/game/log/server2

log on</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Ещё один маленький момент. Для каждой карты можно создать файл-спутник &lt;имя карты&gt;.cfg — для команд, выполняемых сервером при старте этой карты, сразу после выполнения server.cfg. Для стандартных карт файл должен находится в ~/tf2/tf/cfg. А для карт из Steam Workshop, имя файла конфигурации должно выглядеть как "&lt;имя карты&gt;.ugc.cfg" и находиться ему полагается в ~/tf2/tf/cfg/workshop. Этот каталог единый для обоих игровых серверов, что следует учитывать, если оба сервера будут использовать одну и ту же карту из Steam Workshop. Для нашей карты cp_orange_x3, у которой id 454299390, полный путь к её файлу конфигурации будет выглядеть как ~/tf2/tf/cfg/workshop/cp_orange_x3.ugc454299390.cfg <br/>
<p>Для пользовательских карт возможность выполнения <a href="https://developer.valvesoftware.com/wiki/Point_servercommand">некоторых команд</a> из таких файлов конфигурации регулируется серверной командой sv_allow_point_servercommand, по умолчанию имеющей значение "official" — Allowed for valve maps only. Для разрешения выполнения для любой карты необходимо установить её значение в "always" в autoexec2.cfg</p><br/>
<blockquote>Если захочется просто скачать какую-нибудь карту из Steam Workshop, то в консоли игрового сервера достаточно ввести команду <code>tf_workshop_map_sync &lt;id карты&gt;</code>. При этом начнётся отслеживание этой карты — при ручном переходе на неё с помощью <code>changelevel wohrkshop/&lt;id&gt;</code> так же будет проверка на предмет обновления. Посмотреть отслеживаемые карты можно с помощью команды <code>tf_workshop_map_status</code>, ну или в файле ~/tf2/steamapps/workshop{1,2}/appworkshop_440.acf.</blockquote><p>В файле ~/cfg/server1.cfg прописываем команды для первого сервера, которые будут выполняться при каждой смене карты:</p><br/>
<div class="spoiler"><b class="spoiler_title">server1.cfg</b><div class="spoiler_text"><pre><code>// Сообщение на консоль сервера
echo "*** ~/cfg/server1.cfg"

// *** Восстанавливаем значения переменных при смене карты

// Адрес и порт, куда сервер будет транслировать свои логи по UDP для сервера статистики HLstatsX
// Для каждого игрового сервера указываем свой порт
// Нельзя использовать адрес 127.0.0.1 (!)
// Необходим "log on" в каком-нибудь файле конфигурации (у нас установлен в autoexec1.cfg)
logaddress_delall
logaddress_add 192.0.2.0:27500

// Разрешение на использование читерские команды (1 - да, 0 - нет)
sv_cheats 0</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Если мы в какой-то момент отключим ведение логов и их попадание в статистику HLstatsX (ну мало ли зачем может понадобится — на отдельной карте для выполнения достижений, либо решили потусить с ботами) командой <code>logaddress_delall</code> в &lt;имя карты&gt;.cfg, или в консоли или как-то ещё, то указание параметра logaddress_add в server1.cfg обеспечит восстановление трансляции логов при смене карты. А команда logaddress_delall предваряет logaddress_add во избежание ругани "logaddress_add: 192.0.2.0:27500 is already in the list"</p><br/>
<p>Читы у нас и так отключены, но при каждой смене карты всё равно устанавливаем sv_cheats в "0" — на случай, если для каких-то целей (генерация навигационной сетки, например) ранее ручками устанавливали в "1".</p><br/>
<p>В файле ~/cfg/server2.cfg прописываем аналогичные команды для второго сервера:</p><br/>
<div class="spoiler"><b class="spoiler_title">server2.cfg</b><div class="spoiler_text"><pre><code>echo "*** ~/cfg/server2.cfg"

// Обратите внимание - для первого сервера порт был 27500, для второго - 27501 !!!
logaddress_delall
logaddress_add 192.0.2.0:27501

sv_cheats 0

tf_bot_quota 0</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Далее создаём файлы со списком карт для ротации. Для первого сервера, на котором мы будем крутить карты лишь режима Control Point, мы за основу берём уже готовый mapcycle_quickplay_cp.txt, который при желании можно подправить.</p><br/>
<pre><code class="bash">   $ cp ~/tf2/tf/cfg/mapcycle_quickplay_cp.txt ~/cfg/mapcycle1.txt
   $ dos2unix ~/cfg/mapcycle1.txt
   $ chmod 664 ~/cfg/mapcycle1.txt</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Таким образом, в ~/cfg/mapcycle1.txt у нас прописаны карты для ротации на первом сервере:</p><br/>
<div class="spoiler"><b class="spoiler_title">mapcycle1.txt</b><div class="spoiler_text"><pre><code>cp_5gorge
cp_badlands
cp_coldfront
cp_fastlane
cp_freight_final1
cp_granary
cp_well
cp_yukon_final
cp_foundry
cp_gullywash_final1
cp_process_final
cp_standin_final
cp_snakewater_final1
cp_powerhouse
cp_vanguard
cp_sunshine
cp_metalworks</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Для второго сервера файл с картами ~/cfg/mapcycle2.txt создадим вручную. Карту cp_orange_x3 прописываем в том же формате, что и в autoexec2.cfg — "workshop/454299390", либо "workshop/cp_orange_x3.ugc454299390":</p><br/>
<div class="spoiler"><b class="spoiler_title">mapcycle2.txt</b><div class="spoiler_text"><pre><code>// Карта cp_orange_x3 с https://steamcommunity.com/sharedfiles/filedetails/?id=454299390
workshop/cp_orange_x3.ugc454299390</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Теперь создадим файлы с приветственными сообщениями игрокам. Можно в текстовом формате, можно с html разметкой, можно строку с url. При этом максимальный размер файла ограничен где-то 1-2 Кб.</p><br/>
<p>Для первого сервера создаём ~/cfg/motd1.html с гипертекстовым содержимым:</p><br/>
<div class="spoiler"><b class="spoiler_title">motd1.html</b><div class="spoiler_text"><pre><code class="html">&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Message of the day&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Welcome to our server!&lt;/h1&gt;
    &lt;/body&gt;
&lt;/html&gt;</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>и текстовый файл ~/cfg/motd1.txt для игроков, у которых отключён показ html motd (cl_disablehtmlmotd 1):</p><br/>
<div class="spoiler"><b class="spoiler_title">motd1.txt</b><div class="spoiler_text"><pre><code>Welcome!
Have fun and be safe</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Для второго сервера в ~/cfg/motd2.txt укажем внешний url, который будет загружен у игроков в motd окне игры:</p><br/>
<div class="spoiler"><b class="spoiler_title">motd2.txt</b><div class="spoiler_text"><pre><code>http://m.forum.example.org/news.html</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Фишка с url срабатывает лишь для motdfile. При указании в motdfile_text, url будет просто показан как текст.</p><br/>
<p>В интернете можно найти различные руководства по созданию MOTD — <a href="http://steamcommunity.com/sharedfiles/filedetails/?id=143877817">from Jimo</a>, как вариант <a href="http://www.specialattack.net/content/how-create-tf2-chalkboard-style-motd-html">ещё одно</a>.</p><br/>
<p>Всё, основные файлы конфигурации на данном этапе созданы, делаем ссылки на них в каталог cfg игрового сервера:</p><br/>
<pre><code class="bash">   $ ln -s -v ~/cfg/* ~/tf2/tf/cfg/</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<h3 id="setevye-nastroyki">Сетевые настройки</h3><br/>
<p>При запущенном сервере без параметров (как мы делали это в самом начале), если в другом окне терминала запустить <code>netstat -lpn | grep srcds</code>, то мы увидим:</p><br/>
<pre><code>   tcp     0      0 192.0.2.0:27015    0.0.0.0:*     LISTEN      3456/./srcds_linux
   udp     0      0 192.0.2.0:27005    0.0.0.0:*                 3456/./srcds_linux
   udp     0      0 192.0.2.0:27015    0.0.0.0:*                 3456/./srcds_linux
   udp     0      0 192.0.2.0:27020    0.0.0.0:*                 3456/./srcds_linux
   udp     0      0 192.0.2.0:26901    0.0.0.0:*                 3456/./srcds_linux</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Каждый игровой сервер использует свои порты. Они могут задаваться следующими параметрами при запуске srcds:</p><br/>
<p><code>UDP/27005</code><br/>
<code>+clientport</code> — Game client port</p><br/>
<p><code>UDP/27015</code><br/>
<code>-port</code> — The port the server advertises to clients</p><br/>
<p><code>TCP/27015</code><br/>
порт для удалённой консоли, RCON, номер задаётся параметром <code>-port</code>, но использует протокол TCP. Если управление игровым сервером планируется осуществлять исключительно посредством терминального доступа с помощью ssh (а лучше — настроить и забыть), то этот порт с протоколом TCP (не UDP!) можно закрыть, либо вовсе не открыть на файерволе. Но только аккуратно, лишь на внешнем сетевом интерфейсе. Внутри сервера удалённая консоль энергично используется сервером статистики.</p><br/>
<p><code>UDP/27020</code><br/>
<code>-tv_port</code> — SourceTV port (описан в соответствующем разделе "SourceTV")</p><br/>
<p><code>UDP/26901</code><br/>
<code>-steamport</code> — Steam/VAC connection port</p><br/>
<p>Таким образом, для ручной установки этих же портов, используемых по умолчанию, мы в строке запуска первого сервера укажем "-port 27015 -steamport 26900 +clientport 27005 +tv_port 27020". Порт 26900 — это не ошибка, в действительности сервер будет использовать порт на единичку выше.</p><br/>
<p>Для второго сервера надо указать другие значения. В интернете есть советы, что номера портов в подобных мультисерверных конфигурациях лучше увеличивать не последовательно, а через один (27015 -&gt; 27017 -&gt; 27019 и так далее). Но в нашем случае будем увеличивать последовательно. Вроде и так работает.</p><br/>
<p>Тогда второй сервер будем запускать с параметрами "-port 27016 -steamport 26901 +clientport 27006 +tv_port 27021".</p><br/>
<p>Конечно, можно порты не указывать вовсе, ни для первого сервера, ни для второго. В таком случае сервер, стартовавший первым будет использовать порты по умолчанию, а стартовавший вторым немножко ругнётся в логах:</p><br/>
<pre><code>   WARNING: Port 27015 was unavailable - bound to port 27016 instead
   WARNING: Port 27005 was unavailable - bound to port 27006 instead
   WARNING: Port 27020 was unavailable - bound to port 27021 instead
   Network: IP 192.0.2.0, mode MP, dedicated Yes, ports 27016 SV / 27006 CL</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>и будет использовать следующие по порядку. Но всё же мы будем явно указывать номера портов в командной строке, да ещё припечатаем их параметром <code>-strictportbind</code> (описание будет ниже).</p><br/>
<p>Естественно, ничто не запрещает использовать другие номера портов, хоть "-port 50000 +clientport 50001 +tv_port 50002 -steamport 50003", и при этом сервер будет виден через ISteamApps/GetServersAtAddress интерфейс и к нему в принципе можно будет подсоединиться и играть. Но в нашем примере мы будем более традиционны.</p><br/>
<h3 id="skripty-zapuska-servera">Скрипты запуска сервера</h3><br/>
<p>В обычных условиях нам придётся иметь дело с двумя скриптами-обёртками:</p><br/>
<ol>
<li>с консольным клиентом Steam — ~/Steam/steamcmd.sh, который запускает программу linux32/steamcmd. В явном виде используется нами для установки и регулярных обновлений игровых серверов;</li>
<li>с собственно, самим игровым сервером — ~/tf2/srcds_run, который запускает лежащий тут же srcds_linux, а тот уже игру.</li>
</ol><br/>
<p>Для настройки и отладки, когда приходится часто запускать/останавливать сервера, мы создадим скрипты для запуска — ~/start1.sh и ~/start2.sh. Потом их расширим и переделаем для автозапуска. Для первого сервера, ~/start1.sh:</p><br/>
<div class="spoiler"><b class="spoiler_title">start1.sh</b><div class="spoiler_text"><pre><code>#!/bin/sh
#
# Запуск первого сервера.

# Путь к каталогу с игрой, где лежит файл srcds_run
GAMEFOLDER=/home/game/tf2

CMDLINE="-port 27015 -steamport 26900 +clientport 27005 +tv_port 27020 -strictportbind \
    +sv_pure 2 -game tf +maxplayers 24 \
    -pidfile ${GAMEFOLDER}/tf/srcds1.pid \
    -ugcpath ${GAMEFOLDER}/steamapps/workshop1 \
    +exec autoexec1.cfg +servercfgfile server1.cfg"

# Запускаем игровой сервер
${GAMEFOLDER}/srcds_run ${CMDLINE}</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Пояснения по параметрам (начинаются с "-") и консольным переменным (начинаются с "+"):</p><br/>
<p><code>-port</code><br/>
порт для игры. Для первого сервера — 27015. При использовании иных портов, как у нас, необходимо не забыть их открыть на файерволе</p><br/>
<p><code>-steamport</code><br/>
порт для VAC (Valve Anti-Cheat). В действительности будет использоваться на единичку выше. То есть указав 26900, в действительности будет 26901</p><br/>
<p><code>+clientport</code><br/>
порт для подключения игроков</p><br/>
<p><code>+tv_port</code><br/>
порт для SourceTV. Если принципиально не будем пользоваться, то можно вместо +tv_port указать параметр -nohltv</p><br/>
<p><code>-strictportbind</code><br/>
если вышеуказанные порты заняты, то сервер не будет автоматически выбирать следующие свободные, а будет завершаться с ошибкой "ERROR: Port 27015 was unavailable — quitting due to "-strictportbind" command-line flag!". Будет повод почитать логи и найти ошибку.</p><br/>
<p><code>-ip</code><br/>
ip адрес, на котором будет сервер. Можно указать какой-то конкретный, либо 0.0.0.0 — все интерфейсы. Мы параметр не устанавливаем, так как на нашем сервере только один сетевой интерфейс, с внешним ip</p><br/>
<p><code>-game</code><br/>
запускаемая игра. У нас — "tf" — Team Fortress 2.</p><br/>
<p><code>+maxplayers</code><br/>
максимальное количество игровых слотов на сервере. Этот параметр указывается только в командной строке. Значение по умолчанию — 24, может быть увеличено до 32. Для Mann vs. Machine должно быть 32</p><br/>
<p><code>-pidfile</code><br/>
указывает файл для хранения PID сервера.</p><br/>
<p><code>-ugcpath</code><br/>
каталог для скачиваемого контента из Steam Workshop. По умолчанию — ~/tf2/steamapps/workshop. Можно указывать как абсолютный путь так и относительный, от каталога ~/tf2/tf. Так как <a href="http://store.steampowered.com/news/18032/">считается, что</a> использование одного workshop каталога для нескольких игровых серверов не поддерживается и может вызвать проблемы, то для каждого сервера указываем свой.</p><br/>
<p><code>+sv_pure</code><br/>
предназначение этой переменной — уменьшить возможность мошенничества игроков, которые могут у себя на локальном компьютере заменить игровые файлы на читерские (прозрачные текстуры, трассеры у выстрелов, текстуры игроков и так далее). Этот параметр может принимать значения -1, 0, 1, 2. При установке значения sv_pure от 0 и выше, при подключении к нашему серверу игрока, на его компьютере будет осуществляться проверка целостности ключевых файлов его инсталляции игры (контрольная сумма, цифровая подпись), что, очевидно, несколько замедляет подключение игроков. Критерии проверки описаны в pure_server_full.txt, pure_server_minimal.txt и pure_server_whitelist_example.txt из ~/tf2/tf/cfg/. Для установки максимального уровня — <code>sv_pure 2</code>, параметр должен указываться в командной строке srcds_run, чтобы он смог отработать ещё до того, как сервер при запуске начнёт загружать свои .vpk файлы.</p><br/>
<p><code>+exec</code><br/>
имя файла, который будет выполняться при старте сервера сразу после autoexec.cfg. Может указываться несколько раз.</p><br/>
<p><code>+servercfgfile</code><br/>
имя файла, который будет использоваться вместо server.cfg — как при запуске сервера, так и при каждой смене карт</p><br/>
<p><code>+map</code><br/>
имя карты (без расширения). Можно не указывать здесь, но тогда необходимо указать в файле autoexec.cfg (не server.cfg !). Если не задать карту вообще, то сервер войдёт в ступор. Бывают рекомендации указывать этот параметр последним в командной строке. Но мы его не используем, начальную карту будем указывать в autoexec.cfg</p><br/>
<p>Другие параметры командной строки можно посмотреть в <a href="https://developer.valvesoftware.com/wiki/Command_Line_Options#Source_Dedicated_Server">Valve Developer Community wiki</a></p><br/>
<p>Копируем скрипт в ~/start2.sh, корректируем CMDLINE (увеличиваем на единичку номера портов и подправляем имена файлов), сохраняем.</p><br/>
<div class="spoiler"><b class="spoiler_title">start2.sh</b><div class="spoiler_text"><pre><code>#!/bin/sh

# Запуск второго сервера.

GAMEFOLDER=/home/game/tf2

CMDLINE="-port 27016 -steamport 26901 +clientport 27006 +tv_port 27021 -strictportbind \
    +sv_pure 2 -game tf +maxplayers 24 \
    -pidfile ${GAMEFOLDER}/tf/srcds2.pid \
    -ugcpath ${GAMEFOLDER}/steamapps/workshop2 \
    +exec autoexec2.cfg +servercfgfile server2.cfg"

# Запускаем игровой сервер
${GAMEFOLDER}/srcds_run ${CMDLINE}</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Делаем скрипты исполняемыми</p><br/>
<pre><code class="bash">   $ chmod u+x ~/start{1,2}.sh</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Можно запустить первый сервер (из-под пользователя game, не root !), сразу посмотреть что-как. Наблюдаем за последовательностью отработки файлов конфигурации:</p><br/>
<pre><code>   ...
   *** ~/cfg/autoexec.cfg (global)
   Writing cfg/banned_user.cfg.
   Writing cfg/banned_ip.cfg.
   --------------------------------------------------------
   sv_pure set to 2.
   --------------------------------------------------------
   maxplayers set to 24
   *** ~/cfg/autoexec1.cfg
   Server logging enabled.
   Server logging data to file /home/game/log/server1/L1007000.log
   ...
   Executing dedicated server config file server1.cfg
   Using map cycle file 'cfg/mapcycle1.txt'.
   Set motd from file 'cfg/motd1.html'
   Set motd_text from file 'cfg/motd1.txt'
   Connection to game coordinator established.
   tf_server_identity_account_id not set; not logging into registered account
   *** ~/cfg/server1.cfg
   logaddress_delall:  no addresses in the list
   logaddress_add:  192.0.2.0:27500
   'cp_granary.cfg' not present; not executing.
   Connection to Steam servers successful.
   ...</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Плохо, конечно, начинать отношения со лжи. И к серверам это тоже относится. Хотя наш сервер и утверждает, что логи записываются в файл L1007000.log, на самом деле они пишутся в l1007000.log. Разница в регистре первого символа имени — но для Linux какая существенная! Но, кто предупреждён — тот вооружён. Будем критически относится к декларируемым функциям. И забегая вперёд — не напрасно.</p><br/>
<p>Теперь аналогично запускаем второй сервер, любопытствуем, как он подключит нашу карту из Мастерской.</p><br/>
<pre><code>   ...
   *** ~/cfg/autoexec2.cfg
   ...
   [TF Workshop] Waiting for steam connection
   [TF Workshop] Preparing map ID 454299390
   [TF Workshop] Map ID 454299390 isn't tracked, adding
   ...
   [TF Workshop] New version available for map, download queued [ workshop/cp_orange_x3.ugc454299390 ]
   ...
   [TF Workshop] Installed subscribed map [ workshop/cp_orange_x3.ugc454299390 ]
   [TF Workshop] Successfully prepared client map from workshop [ workshop/cp_orange_x3.ugc454299390 ]
   ...
   'workshop/cp_orange_x3.ugc454299390.cfg' not present; not executing.
   ...</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Хорошо, годно. У второго сервера ресурсы из Steam Workshop скачались в ~/tf2/steamapps/workshop2, и наша карта находится по пути ~/tf2/steamapps/workshop2/content/440/454299390/cp_orange_x3.bsp. В строчках выше, "[ workshop/cp_orange_x3.ugc454299390 ]" — это не путь к карте, а её имя. Подробнее описывалось ранее, когда создавали файл autoexec2.cfg</p><br/>
<p>Снова запускаем на своём компьютере Team Fortress 2, "Find a game" — "Community servers" — "Избранное" — "Добавить" — вводим ip адрес сервера "192.0.2.0" — "Найти игры по этому адресу" — видим оба наших сервера. Работает :-). Добавим их в закладки.</p><br/>
<p>Можно посмотреть, как видны наши сервера с точки зрения мастер-серверов Valve с помощью интерфейса Web API, открыв в браузере ссылку и указав ip нашего сервера <a href="http://api.steampowered.com/ISteamApps/GetServersAtAddress/v0001?addr=192.0.2.0">http://api.steampowered.com/ISteamApps/GetServersAtAddress/v0001?addr=192.0.2.0</a> — так можно посмотреть все игровые source сервера на любом адресе, не только Team Fortress 2</p><br/>
<p>Останавливаем сервера (quit, затем Ctrl+C), продолжаем настройку.</p><br/>
<blockquote>Завершать работу сервера, запущенного посредством srcds_run, как в наших скриптах, лучше всего введя сначала команду <code>quit</code>, а когда на экране появится завершающее работу сообщение вида "Sat Jun 18 10:28:33 VOST 2016: Server restart in 10 seconds", то тут уже Ctrl+C. Если прибить сервер без корректного выхода, то останутся недописанными логи — сервер буферизирует их вывод по 8 кб. Можно пропустить что-нибудь напоследок интересное.</blockquote><br/>
<h1 id="obnovlenie-serverov">Обновление серверов</h1><br/>
<p>Обычно процедуре обновления серверов посвящают всего десяток строчек, и, положа руку на сердце, для большинства конфигураций этого достаточно, но в нашем случае уделим этому вопросу целый раздел.</p><br/>
<p>Время от времени Valve выпускает обновления как для клиентов, так и для серверов, и обновлённые клиенты зачастую отказываются подключаться к необновлённым серверам:</p><br/>
<p></p><br/>
<p>Обновления для серверов бывают обязательные — без установки которых обновлённые клиенты не смогут подключиться к ним, и опциональные — их (не)установка не повлияет на возможность подключения игроков. Отличить обязательные от необязательных можно очень просто — по анонсу ответственных товарищей из Valve в официальном списке рассылки <a href="https://list.valvesoftware.com/cgi-bin/mailman/listinfo/hlds_linux">https://list.valvesoftware.com/cgi-bin/mailman/listinfo/hlds_linux</a>. Когда они пишут, что "Optional TF2 update released" — то это не обязательное обновление. А когда "Mandatory Team Fortress 2 update released" — то это обязательное. Серъезно. На момент написания, по их словам, единственный официальный способ узнать о выпуске нового обновления — это список рассылки hlds_linux.</p><br/>
<p>Обновлять игровые сервера можно несколькими способами.</p><br/>
<h2 id="avtomaticheskoe">Автоматическое</h2><br/>
<p>В простейшем случае обновление игровых серверов мы можем отдать на откуп им самим — включив в параметры запуска обоих серверов строку:</p><br/>
<div class="spoiler"><b class="spoiler_title">start1.sh</b><div class="spoiler_text"><pre><code>CMDLINE="...
    -autoupdate -steam_dir /home/game/Steam -steamcmd_script /home/game/cfg/tf2_update \
    ...</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p><code>-autoupdate</code><br/>
будут автоматически устанавливаться обновления сервера. Требует наличия двух следующих параметров</p><br/>
<p><code>-steam_dir</code><br/>
путь к каталогу где лежат файлы steam.sh и steamcmd.sh</p><br/>
<p><code>-steamcmd_script</code><br/>
скрипт для обновления, ищется в "-steam_dir", но можно указать с абсолютным путём</p><br/>
<blockquote>На самом деле, эта триада параметров перед каждым (пере)запуском сервера всего лишь выполняет <code>./srcds_run +runscript ~/cfg/tf2_update</code></blockquote><p>В каталоге ~/cfg создаём файл tf2_update — в нём укажем команды для автоматического обновления сервера. Эти команды в сущности повторяют те, которые мы указывали в командной строке при инсталляции игрового сервера.</p><br/>
<div class="spoiler"><b class="spoiler_title">tf2_update</b><div class="spoiler_text"><pre><code>@ShutdownOnFailedCommand 0
@NoPromptForPassword 1
login anonymous
force_install_dir /home/game/tf2/
app_update 232250
quit</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Пояснения по командам:</p><br/>
<p><code>@ShutdownOnFailedCommand</code><br/>
руководство Valve рекомендует устанавливать эту переменную в "0" при обновлении нескольких игровых серверов.</p><br/>
<p><code>@NoPromptForPassword</code><br/>
данная переменная, установленная в "1", при логине в Steam отключает интерактивный запрос пароля, если он не указан в строке login. Если пароль для данного имени пользователя всё же требуется, то во входе будет отказано.</p><br/>
<p><code>login &lt;username&gt; [&lt;password&gt;] [&lt;Steam guard сode&gt;]</code><br/>
осуществляет логин в Steam. В данном случае должна быть указана обязательно, иначе при запуске будет выдавать ошибку "ERROR! Failed to request AppInfo update, not online or not logged in to Steam." Первым аргументом можно указать "anonymous" — будет осуществляться анонимный вход. Применительно к выделенным игровым серверам, большинство позволяют подключаться анонимно для инсталляции и установки обновлений, но некоторые могут требовать вход по имени пользователя и паролю. Список серверов с их требованиями и некоторыми параметрами можно посмотреть в <a href="https://developer.valvesoftware.com/wiki/Dedicated_Servers_List">Dedicated Servers List</a>. При неанонимном логине, как обычно при входе с нового компьютера, на электронную почту приходит код steam guard, который указывается либо здесь, либо в отдельной команде set_steam_guard_code.</p><br/>
<p><code>set_steam_guard_code &lt;сode&gt;</code><br/>
указывается код steam guard. Для анонимного логина не используется.</p><br/>
<p><code>force_install_dir</code><br/>
по умолчанию программы устанавливаются в каталог ./SteamApps/common/&lt;имя игры&gt;. Если мы хотим установить в другой, то указываем его как параметр данной команды. Должно быть указано до команды app_update.</p><br/>
<p><code>app_update &lt;appid&gt; [-validate] [-language &lt;lang&gt;] [-beta &lt;betaname&gt;] [-betapassword &lt;pwd&gt;]</code><br/>
начинает скачивать (если ещё не), либо обновлять существующую инсталляцию программы. Необходимо указание appid. Возможно указание опции validate — в этом случае будет осуществляться проверка целостности инсталляции и, при необходимости, дополнительно скачиваться отсутствующие либо изменённые файлы. По факту, аналогично выполнению команды <a href="https://support.steampowered.com/kb_article.php?p_faqid=282&amp;l=russian">"Проверить целостность кэша..."</a> в клиенте Steam, с той разницей, что выполняется для игрового сервера. Очевидно, что существенно замедляет обновление, и лучше её указывать вручную, когда возникает такая необходимость, как мы это делали при первоначальной инсталляции сервера.</p><br/>
<p><code>app_set_config &lt;appid&gt; &lt;key&gt; &lt;value&gt;</code><br/>
указывает дополнительные параметры для приложения.</p><br/>
<p>Подробнее по командам и переменным клиента Steam можно почитать в родной справке, запустив steamcmd.sh без параметров. Работают команды <code>help</code>, <code>find &lt;подстрока&gt;</code>.</p><br/>
<p>Когда в процессе своей жизнедеятельности игровой сервер получает от мастер-серверов Steam информацию о новом обновлении, он начинает каждые пять минут канючить о необходимости перезапуститься.</p><br/>
<p>В консоли сервера:</p><br/>
<pre><code>   ^CMasterRequestRestart
   Your server will be restarted on map change.
   Your server will be restarted on map change.
   Your server needs to be restarted in order to receive the latest update.
   Your server needs to be restarted in order to receive the latest update.</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>И в логах:</p><br/>
<pre><code>   L 07/08/2016 - 05:07:17: Your server will be restarted on map change.
   L 07/08/2016 - 05:07:17: Your server needs to be restarted in order to receive the latest update.</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>При при очередных сменах карт сервера завершат работу, выполнят команды из ~/cfg/tf2_update и, обновлённые, запустятся заново. При этом ничего страшного не произойдёт даже в случае одновременной смены карт и обновления.</p><br/>
<p></p><br/>
<p>Ну, может, кроме повышенного расхода траффика.</p><br/>
<p>В подавляющем большинстве случаев достаточно использовать этот режим обновлений. Но бывают варианты, когда на одном из серверов карта меняться будет очень нескоро, а то и вовсе не будет. Ведь если специально не устанавливать критерии окончания игры на данной карте, ограничивая количество раундов (переменная mp_maxrounds, по умолчанию = 0), побед (mp_winlimit = 0), фрагов (mp_fraglimit = 0), таймаут (mp_timelimit = 0), и так далее, то не будет смены карты и, как следствие, обновления. Да и мало ли какие карты и игровые режимы захочется использовать на том же втором сервере, и жалко терять новых игроков из-за того, что они не могут подключиться к нашему устаревшему серверу.</p><br/>
<p>Тогда на помощь приходят другие варианты.</p><br/>
<h2 id="periodicheskoe-obnovlenie">Периодическое обновление</h2><br/>
<p>Мы можем зайти с другой стороны — регулярно по cron запускать steamcmd.sh с командами установки обновлений (да, "по-живому"), анализировать результаты и при успешном обновлении инициировать перезапуск игровых серверов.</p><br/>
<p>Так, при запуске <code>~/Steam/steamcmd.sh +runscript ~/cfg/tf2_update</code> и при отсутствии обновлений сервера, steamcmd.sh порадует нас сообщением:</p><br/>
<pre><code>   ...
   Connecting anonymously to Steam Public...Logged in OK
   Waiting for license info...OK
   Success! App '232250' already up to date.</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>При наличии обновлений, после автоматического скачивания и в случае успешной установки:</p><br/>
<pre><code>   ...
   Update state (0x61) downloading, progress: 99.63 (3616706682 / 3630011517)
   Update state (0x81) committing, progress: 100.00 (606937472 / 606937472)
   Success! App '232250' fully installed.</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Вот на "fully installed" и будем проверять. Реализовываем. Создаём скрипт ~/update.sh:</p><br/>
<div class="spoiler"><b class="spoiler_title">update.sh</b><div class="spoiler_text"><pre><code>#!/bin/sh

~/Steam/steamcmd.sh +login anonymous +force_install_dir /home/game/tf2/ +app_update 232250 +quit &gt; ~/steamcmd.log

if grep --quiet "fully installed" ~/steamcmd.log; then
    # kill `cat /home/game/tf2/tf/srcds1.pid`
    # ~/start1.sh &amp;
    # kill `cat /home/game/tf2/tf/srcds2.pid`
    # ~/start2.sh &amp;
fi

rm -f ~/steamcmd.log</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Да, установку обновлений можно запускать, как указывая параметры в командной строке steamcmd.sh — "+login anonymous +force_install_dir ~/tf2/ +app_update 232250 +quit", так и с помощью ранее созданного файлика tf2_update — "+runscript ~/cfg/tf2_update"</p><br/>
<p>Скрипт минималистичен и жесток, поэтому в таком виде его использовать не будем. А вот после окончательной настройки запуска игровых серверов, как в разделе "Автозапуск игровых серверов", с использованием tmux в скриптах запуска и настройки sudo, можно предварительно предупреждать пользователей о грядущем рестарте, да и выполнять его цивилизованнее. Тогда скрипт примет более приемлемый вид:</p><br/>
<div class="spoiler"><b class="spoiler_title">update.sh (v2)</b><div class="spoiler_text"><pre><code>#!/bin/sh

~/Steam/steamcmd.sh +login anonymous +force_install_dir /home/game/tf2/ +app_update 232250 +quit &gt; ~/steamcmd.log

if grep --quiet "fully installed" ~/steamcmd.log; then
    echo "Update installed"

    tmux -L socket1 send-keys "say New update installed. Server will be restarted in 10 seconds. Please join us after a minute" Enter
    tmux -L socket2 send-keys "say New update installed. Server will be restarted in 10 seconds. Please join us after a minute" Enter

    sleep 10s

    sudo /usr/bin/systemctl reload srcds1.service
    sudo /usr/bin/systemctl reload srcds2.service
else
        echo "Update not found"
fi

rm -f ~/steamcmd.log</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Вместо "say", если уже установлен SourceMod можно использовать <a href="https://forums.alliedmods.net/showthread.php?t=56764">его варианты</a> команд.</p><br/>
<p>Такой вариант обновления активируем через наш crontab файл, не забывая сделать сам скрипт исполняемым:</p><br/>
<pre><code>   $ chmod 744 ~/update.sh
   $ crontab -e</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Прописываем запуск каждые полчаса:</p><br/>
<div class="spoiler"><b class="spoiler_title">crontab</b><div class="spoiler_text"><pre><code>*/30 * * * * ~/update.sh</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Настройка перенаправления логов cron в лог, доступный пользователю game описано в разделе "Логи"</p><br/>
<h2 id="tolko-proverka">Только проверка</h2><br/>
<p>В некоторых случаях может потребоваться лишь проверить наличие обновлений, не устанавливая их прямо сейчас.</p><br/>
<p>У Valve имеется <a href="https://developer.valvesoftware.com/wiki/Steam_Web_API">Steam Web API</a>. Проверять наличие обновлений программ можно с использованием интерфейса ISteamApps/UpToDateCheck, например, для самой игры Team Fortress 2 — <a href="http://api.steampowered.com/ISteamApps/UpToDateCheck/v1?appid=440&amp;version=3528598">http://api.steampowered.com/ISteamApps/UpToDateCheck/v1?appid=440&amp;version=3528598</a>, указав в параметре version текущую версию игры (либо просто какую-нибудь цифру). Но при выборе appid = 232250 (а, равно, как и для многих других выделенных серверов), выдаётся ошибка "Couldn't get app info for the app specified.". Увы.</p><br/>
<p>Но, к счастью, именно для нашего Team Fortress 2 dedicated server есть отдельный интерфейс — <a href="https://api.steampowered.com/IGCVersion_440/GetServerVersion/v1?format=json">https://api.steampowered.com/IGCVersion_440/GetServerVersion/v1?format=json</a>. При выполнении выдаётся что-то вида:</p><br/>
<pre><code>   {
     "result": {
     "success": true,
     "deploy_version": 3531256,
     "active_version": 3531256,
     "min_allowed_version": 3528598
     }
   }</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Формат выводимой информации можно указывать в строке запроса — json, xml, vdf. Последний — <a href="https://developer.valvesoftware.com/wiki/KeyValues">Valve Data Format</a>, проприетарный формат Valve, очень похожий на json и легко в него конвертируемый. Используется во многих файлах — items_game.txt, в Записях, в .acf, .vdf и так далее.</p><br/>
<p>Вообще, поля deploy_version и active_version используются Valve для отслеживания версий, запущенных на их собственных серверах, и они не обязаны всегда совпадать с текущими публичными версиями. Но, с учётом этих рисков, всё же можно попробовать использовать данный api.</p><br/>
<p>Узнать установленную у нас версию сервера можно введя <code>version</code> в консоли сервера, либо посмотрев в ~/tf2/tf/steam.inf</p><br/>
<p>Таким образом, при необходимости, можно периодически проверять актуальную версию сервера через Web API, сравнивать с установленной у нас, ну а непосредственно обновление и рестарт игровых серверов были описаны выше. Например как-то так:</p><br/>
<div class="spoiler"><b class="spoiler_title">update.sh (v3)</b><div class="spoiler_text"><pre><code>#!/bin/sh

wget -q --no-check-certificate "https://api.steampowered.com/IGCVersion_440/GetServerVersion/v1?format=json" -O=~/GameVersion.json

VERSION_DEPLOYED=`grep deploy_version ~/GameVersion.json | sed -s 's/[^[:digit:]]//g'`

VERSION_INSTALLED=`grep ServerVersion ~/tf2/tf/steam.inf | sed -s 's/[^[:digit:]]//g'`

if [[ $VERSION_DEPLOYED -gt $VERSION_INSTALLED ]]; then
   echo "New update is ready, $VERSION_DEPLOYED vs $VERSION_INSTALLED"
   # Что-то делаем

fi</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Всё, можно включать в crontab.</p><br/>
<p>Справедливости ради, это далеко не единственные способы получения информации об обновлениях. Помимо того, что ещё скрывается в недрах Steam Web API, текущий билд нашего сервера можно посмотреть в ~/tf2/steamapps/appmanifest_232250.acf, параметр "buildid". Актуальную версию можно запросить — <code>steamcmd.sh +login anonymous +app_info_update 1 +app_info_print 232250 +quit</code>, а там смотрим значение параметра "buildid" из пути depots -&gt; branches -&gt; public (иногда app_info_print тупит, показывает устаревшую закешированную информацию, не спасает даже app_info_update 1. Тогда поможет предварительное rm -f ~/Steam/appcache/appinfo.vdf). Автоматически извлекать номера билдов можно как цепочкой из полудюжины grep, cut, tr и прочих команд, с известными допущениями о структуре и порядке строк, так и путём приведения исходных данных к формату json (хотя бы с помощью sed + tr) с последующим использованием стандартных инструментов.</p><br/>
<blockquote>Окончательный выбор способа обновления будет сделан в разделе "Автозапуск игровых серверов".</blockquote><br/>
<ul>
<li><a href="https://habrahabr.ru/post/312928/">Часть 2</a> — Записи (Replay), SourceTV, Fast Download, боты</li>
<li><a href="https://habrahabr.ru/post/312934/">Часть 3</a> — Установка MetaMod и SourceMod, скрипты запуска, логи, аккаунт Steam и <del>QuickPlay</del></li>
<li><a href="https://habrahabr.ru/post/312936/">Часть 4</a> — Сервер статистики HLstatsX</li>
</ul></p></p></div></div></div><!----><!----></div><!----><!----></div><!--]--><!----><div class="tm-article-presenter__meta" data-test-id="article-meta-links"><div class="tm-separated-list tag-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span><ul class="tm-separated-list__list"><!--[--><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[srcds]" class="link"><span>srcds</span></a><!--]--></li><!--]--><!----></ul></div><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span><ul class="tm-separated-list__list"><!--[--><li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/nix/" class="link"><!--[--><span>*nix</span><!--]--></a><!--]--></li><!--]--><!----></ul></div></div><!----><!--]--></article><!--]--></div><!----></div><div style="" class="tm-article-sticky-panel" data-test-id="article-sticky-panel"><div class="tm-data-icons tm-data-icons tm-data-icons_space-big tm-article-sticky-panel__icons" data-test-id="article-stats-icons"><div class="article-rating tm-data-icons__item" data-v-b9b05a90><div class="tm-votes-meter votes-switcher" data-v-b9b05a90><svg class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon tm-votes-meter__icon_appearance-article" height="24" width="24"><title>Всего голосов 22: ↑18 и ↓4</title><use xlink:href="/img/megazord-v28.cba4c116..svg#counter-rating"></use></svg><span class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_appearance-article tm-votes-meter__value_rating tm-votes-meter__value" data-test-id="votes-meter-value" title="Всего голосов 22: ↑18 и ↓4">+12</span></div><!--teleport start--><!--teleport end--><!----></div><!----><!----><button class="bookmarks-button tm-data-icons__item" title="Добавить в закладки" type="button" data-v-861e2740><span class="tm-svg-icon__wrapper icon" data-v-861e2740><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Добавить в закладки</title><use xlink:href="/img/megazord-v28.cba4c116..svg#counter-favorite"></use></svg></span><span class="counter" title="Количество пользователей, добавивших публикацию в закладки" data-v-861e2740>108</span></button><div class="sharing tm-data-icons__item" title="Поделиться" data-v-daf6ee1d><button class="sharing-button" type="button" data-v-daf6ee1d><svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="icon" data-v-daf6ee1d><path fill="currentColor" d="M13.8 13.8V18l7.2-6.6L13.8 5v3.9C5 8.9 3 18.6 3 18.6c2.5-4.4 6-4.8 10.8-4.8z"></path></svg></button><!--teleport start--><!--teleport end--></div><div class="article-comments-counter-link-wrapper tm-data-icons__item" title="Читать комментарии" data-v-8d952463><a href="/ru/articles/312922/comments/" class="article-comments-counter-link" data-test-id="counter-comments" data-v-8d952463><!--[--><svg class="tm-svg-img icon" height="24" width="24" data-v-8d952463><title>Комментарии</title><use xlink:href="/img/megazord-v28.cba4c116..svg#counter-comments"></use></svg><span class="value" data-v-8d952463>10</span><!--]--></a><!----></div><!--[--><!--[--><!--[--><!----><!--]--><!--]--><!--]--><!--teleport start--><!--teleport end--><!----></div></div></div><!--[--><!--]--><div class="tm-article-presenter__footer"><!--[--><!--[--><div class="tm-article-blocks"><!----><!--[--><section class="tm-block tm-block tm-block_spacing-bottom"><!----><!--[--><div class="tm-block__body tm-block__body tm-block__body_variant-balanced"><!--[--><div class="article-author" data-test-id="article-author-info" data-async-called="true" data-v-af0d0f90><!--[--><!--]--><div class="tm-user-card tm-user-card tm-user-card_variant-article user-card" data-async-called="true" data-v-af0d0f90><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/abrca/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><!--[--><div class="tm-entity-image"><!--[--><!--]--></div><!--]--></a><div class="tm-user-card__meta"><div class="tm-counter-container karma" title=" 17 голосов " data-v-544d285f><div class="tm-counter-container__header"><!--[--><div class="karma-display positive" data-v-544d285f data-v-3881f4ba>13</div><!----><!--]--></div><div class="tm-counter-container__footer"><!--[--><div class="karma-text" data-v-544d285f>Карма</div><!--teleport start--><!--teleport end--><!--]--></div></div><div class="tm-counter-container"><div class="tm-counter-container__header"><!--[--><!--[--><!--]--><div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-rating"><!----><div class="tm-votes-lever__score tm-votes-lever__score_appearance-rating tm-votes-lever__score" data-test-id="lever-score"><!--[--><span><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter_rating tm-votes-lever__score-counter" data-test-id="votes-score-counter">0</span></span><!--]--></div><!----></div><!--]--></div><div class="tm-counter-container__footer"><!--[--><span class="tm-rating__text tm-rating__text">Общий рейтинг</span><!--]--></div></div></div></div></div><div class="tm-user-card__info tm-user-card__info_variant-article tm-user-card__info"><div class="tm-user-card__title tm-user-card__title_variant-article tm-user-card__title"><!----><a href="/ru/users/abrca/" class="tm-user-card__nickname tm-user-card__nickname tm-user-card__nickname_variant-article"><!--[-->@abrca<!--]--></a><!----></div><p class="tm-user-card__short-info tm-user-card__short-info_variant-article tm-user-card__short-info" data-test-id="user-card-speciality">Пользователь</p></div></div><!----><div class="tm-user-card__buttons tm-user-card__buttons_variant-article tm-user-card__buttons"><!----><div class="tm-user-card__button"><div class="tm-button-follow tm-user-card__button-follow"><!----><button class="tm-button-follow__button tm-button-follow__button_big" data-test-id="follow-button" type="button">Подписаться</button></div></div><!----><!--[--><div class="tm-user-card__button tm-user-card__button_write" data-test-id="user-card-conversations"><svg class="tm-svg-img tm-user-card__button-icon" height="16" width="16"><title>Отправить сообщение</title><use xlink:href="/img/megazord-v28.cba4c116..svg#mail"></use></svg></div><!--]--><!----><!----></div><!----></div><div class="author-contacts" data-test-id="author-contacts" data-v-af0d0f90><!----><!----><!----></div></div><!--]--></div><!--]--><!----></section><!----><!--[--><div class="sponsor-block" style="--d75346b8:0;--11dbf66e:100%;" data-v-580b3119><div class="title" data-v-580b3119>Хабр доступен 24/7 благодаря поддержке друзей</div><div class="content-container" data-v-580b3119><div class="content" data-v-580b3119><div class="content-title-container" data-v-580b3119><div class="content-title" data-v-580b3119>Хабр Курсы для всех</div><div class="sponsor-mark" data-v-580b3119>РЕКЛАМА</div></div><div class="content-text" data-v-580b3119> Практикум, Хекслет, SkyPro, авторские курсы — собрали всех и попросили скидки. Осталось выбрать! </div><a class="content-action" href="https://career.habr.com/courses/?erid=2VSb5wDLYUH&amp;utm_source=habr&amp;utm_medium=sponsorship_hub" target="_blank" data-v-580b3119><button class="btn btn_solid btn_small tm-button_color-horizon" tabindex="0" type="button" data-v-580b3119><!--[--><!--[-->Перейти<!--]--><!--]--></button></a></div></div><div class="footer" data-v-580b3119><!----></div><!----></div><!--]--><!--]--><div class="tm-article-blocks__comments"><div id="publication-comments" class="tm-article-page-comments"><div><!--[--><div class="article-comments-counter-link-wrapper tm-article-comments-counter-button" data-v-8d952463><a href="/ru/articles/312922/comments/" class="article-comments-counter-link button-style" data-test-id="counter-comments" data-v-8d952463><!--[--><svg class="tm-svg-img icon icon--contrasted" height="24" width="24" data-v-8d952463><title>Комментарии</title><use xlink:href="/img/megazord-v28.cba4c116..svg#counter-comments"></use></svg><span class="value value--contrasted" data-v-8d952463> Комментарии 10 </span><!--]--></a><!----></div><!--]--></div></div></div><!--[--><!--[--><!--]--><section class="tm-block tm-block tm-block_spacing-bottom"><header class="tm-block__header tm-block__header tm-block__header_variant-borderless"><div class="tm-block__header-container"><h2 class="tm-block__title tm-block__title tm-block__title_variant-large">Публикации</h2><!--[--><!--]--></div><!----></header><!--[--><div class="tm-block__body tm-block__body tm-block__body_variant-condensed-slim"><!--[--><!--[--><div class="tabs" data-test-id="container" data-v-681e7545><div class="" data-test-id="scroll-area" data-v-681e7545><!--[--><span class="tab-item" data-v-681e7545><button class="active slim tab-link" data-v-681e7545>Лучшие за сутки</button></span><span class="tab-item" data-v-681e7545><button class="slim tab-link" data-v-681e7545>Похожие</button></span><!--]--></div><!----></div><div class="similar-and-daily__tab-view"><div class="daily-articles-list"><ul class="article-card-list" data-v-7f7081d6><!--[--><!--]--><div class="tm-bordered-card" data-v-7f7081d6><!----><!--[--><!--]--></div></ul><div class="daily-articles-block__button-container"><button class="btn btn_transparent btn_small tm-button_color-horizon" tabindex="0" type="button"><!--[--><!--[-->Показать лучшие за всё время<!--]--><!--]--></button></div></div><!----></div><!--]--><!--]--></div><!--]--><!----></section><!--[--><div><div class="placeholder-wrapper"><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><div class="tm-placeholder-promo"><div class="tm-placeholder-promo__header"><div class="tm-placeholder__line tm-placeholder__line_promo-title"></div></div><div class="tm-placeholder-promo__body"><div class="tm-placeholder-promo__posts"><div class="tm-placeholder-promo__post"><div class="tm-placeholder-promo__image"></div><div class="tm-placeholder__line tm-placeholder__line_post-title"></div></div><div class="tm-placeholder-promo__post"><div class="tm-placeholder-promo__image"></div><div class="tm-placeholder__line tm-placeholder__line_post-title"></div></div><div class="tm-placeholder-promo__post"><div class="tm-placeholder-promo__image"></div><div class="tm-placeholder__line tm-placeholder__line_post-title"></div></div></div><div class="tm-placeholder-promo__dots"><div class="tm-placeholder-promo__dot"></div><div class="tm-placeholder-promo__dot"></div><div class="tm-placeholder-promo__dot"></div></div></div></div><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----></div></div><div class="placeholder-wrapper"><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><div class="tm-placeholder-inset tm-placeholder-vacancies"><div class="tm-placeholder-inset__header"><div class="tm-placeholder__line tm-placeholder__line_inset-header loads"></div></div><div class="tm-placeholder-inset__body"><ul class="tm-placeholder-list"><!--[--><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><!--]--></ul></div><div class="tm-placeholder-inset__footer"><div class="tm-placeholder__line tm-placeholder__line_inset-footer loads"></div></div></div><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----></div><!--]--><!----><!--[--><!--]--><!--]--></div><!----><!--]--><!--]--></div></div><!--]--></div><!--]--></div></div><div class="tm-page__sidebar"><!--[--><div class="sidebar" data-v-0050f56d><div id="sidebar-window-placement" data-v-0050f56d></div><!--[--><!--]--></div><!--]--></div></div><!--]--></div><!----></div></main><!----></div><div class="tm-footer-menu"><div class="tm-page-width"><!--[--><div class="tm-footer-menu__container"><!--[--><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">Ваш аккаунт</p><div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><!--[--><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/articles/312922/&amp;hl=ru" rel="nofollow" target="_self">Войти</a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/articles/312922/&amp;hl=ru" rel="nofollow" target="_self">Регистрация</a></li><!--]--></ul></div></div><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">Разделы</p><div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><!--[--><li class="tm-footer-menu__list-item"><a href="/ru/articles/" class="footer-menu__item-link">Статьи</a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">Новости</a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">Хабы</a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">Компании</a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">Авторы</a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">Песочница</a></li><!--]--></ul></div></div><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">Информация</p><div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><!--[--><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">Устройство сайта</a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">Для авторов</a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">Для компаний</a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">Документы</a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement/?hl=ru_RU" target="_blank">Соглашение</a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/?hl=ru_RU" target="_blank">Конфиденциальность</a></li><!--]--></ul></div></div><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">Услуги</p><div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><!--[--><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/corporate-blogs/" target="_blank">Корпоративный блог</a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/advertising/" target="_blank">Медийная реклама</a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/native-special/" target="_blank">Нативные проекты</a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/education-programs/" target="_blank">Образовательные программы</a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/hello-startup/" target="_blank">Стартапам</a></li><!--]--></ul></div></div><!--]--></div><!--]--></div></div><div class="tm-footer"><div class="tm-page-width"><!--[--><div class="tm-footer__container"><!----><div class="social-icons tm-footer__social" data-v-d6e8cb42><!--[--><a class="tm-svg-icon__wrapper social-icon" href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" data-v-d6e8cb42><svg class="tm-svg-img tm-svg-icon" height="36" width="36"><title>VK</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-vk"></use></svg></a><a class="tm-svg-icon__wrapper social-icon" href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" data-v-d6e8cb42><svg class="tm-svg-img tm-svg-icon" height="36" width="36"><title>Telegram</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a class="tm-svg-icon__wrapper social-icon" href="http://www.youtube.com/@Habr_com" rel="nofollow noopener noreferrer" target="_blank" data-v-d6e8cb42><svg class="tm-svg-img tm-svg-icon" height="36" width="36"><title>Youtube</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a class="tm-svg-icon__wrapper social-icon" href="https://dzen.ru/habr" rel="nofollow noopener noreferrer" target="_blank" data-v-d6e8cb42><svg class="tm-svg-img tm-svg-icon" height="36" width="36"><title>Яндекс Дзен</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-dzen"></use></svg></a><!--]--></div><!--teleport start--><!--teleport end--><button class="tm-footer__link"><!----> Настройка языка</button><a href="/ru/feedback/" class="tm-footer__link">Техническая поддержка</a><div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2026,</span><span class="tm-copyright__name"><a class="tm-copyright__link" href="https://company.habr.com/" rel="noopener" target="_blank"> Habr </a></span></span></div></div><!--]--></div></div><!----><!----><!--]--></div><!----></div></div>
    <div id="overlays"><!--teleport start anchor--><template><!----></template><!--teleport anchor--><!--teleport start anchor--><template><!----></template><!--teleport anchor--><!--teleport start anchor--><template><!----></template><!----><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor--></div>
    
    
    
    
  
  
    
  
    </body>

    </html>

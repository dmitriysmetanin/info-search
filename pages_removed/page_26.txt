<!DOCTYPE html>
<html lang="ru">

  <head>
    <title>Настройка выделенного сервера Source под Linux, часть 4 &#x2F; Хабр</title>

































    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
  </head>
  <body>
    
    <div id="mount"><div id="app"><div class="tm-layout__wrapper"><!--[--><!----><div></div><div class="header-banner-wrapper"><div class="element-wrapper above-header" style="--754c4550:100%;--56cb6579:auto;"><!--[--><div class="placeholder-wrapper banner-container__placeholder"><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><div class="adfox-banner-placeholder above-header" data-v-24012b5e><div class="image loads" data-v-24012b5e></div><div class="lines" data-v-24012b5e><div class="line loads" data-v-24012b5e></div><div class="line loads" data-v-24012b5e></div><div class="line loads" data-v-24012b5e></div></div></div><!----><!----><!----></div><!--[--><div id="adfox_175449164307199013_aboveHeader" class="banner-target"></div><!--]--><!--]--></div></div><header class="tm-header tm-header" data-test-id="header"><!----><!----><div class="tm-page-width"><!--[--><div class="tm-header__container"><button aria-expanded="false" aria-label="Toggle menu" class="burger-button tm-header__button tm-header__burger" data-v-56ed7aae><span class="line top" data-v-56ed7aae></span><span class="line middle" data-v-56ed7aae></span><span class="line bottom" data-v-56ed7aae></span></button><span class="tm-header__logo-wrap"><a class="tm-header__logo tm-header__logo_hl-ru tm-header__logo" href="/ru/feed"><svg class="tm-svg-img tm-header__icon" height="16" width="16"><title>Хабр</title><use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a></span><span class="tm-header__divider"></span><!--[--><a class="tm-header__all-flows" href="/ru/articles/">Все потоки</a><!--]--><!----><div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search" data-test-id="search-button"><svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search" height="24" width="24"><title>Поиск</title><use xlink:href="/img/megazord-v28.cba4c116..svg#search"></use></svg></a><!----><!----><div class="tm-header-user-menu__item tm-header-user-menu__write"><a href="/ru/sandbox/start/" class=""><svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_write" height="24" width="24"><title>Написать публикацию</title><use xlink:href="/img/megazord-v28.cba4c116..svg#write"></use></svg></a><!----></div><!--[--><div class="tm-header-user-menu__item"><button class="tm-header-user-menu__toggle" data-test-id="user-menu-settings"><svg class="tm-svg-img tm-header-user-menu__icon" height="24" width="24"><title>Настройки</title><use xlink:href="/img/megazord-v28.cba4c116..svg#page-settings"></use></svg></button></div><a href="https://habr.com/kek/v1/auth/habrahabr/?back=/ru/articles/312936/&amp;hl=ru" rel="nofollow" class="tm-header-user-menu__item tm-header-user-menu__login" role="button"><!--[-->Войти<!--]--></a><!--]--><template><!----></template><!--teleport start--><!--teleport end--></div></div><!--]--></div></header><div class="tm-layout"><div class="tm-page-progress-bar"></div><!----><div class="tm-page-width"><!--[--><!----><!----><!----><!--]--></div><main class="tm-layout__container"><div class="tm-page" hl="ru" data-async-called="true" style="--a414e232:300px;--10c4682a:0;--19620736:0;"><!----><div class="tm-page-width"><!--[--><!----><div class="tm-page__wrapper"><!----><div class="tm-page__main_has-sidebar tm-page__main"><div class="pull-down"><!----><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg class="tm-svg-img pull-down__icon pull-down__arrow" height="24" width="24"><title>Обновить</title><use xlink:href="/img/megazord-v28.cba4c116..svg#pull-arrow"></use></svg></div></div><!--[--><div><!--[--><!----><div class="tm-article-presenter" data-async-called="true"><!--[--><!--]--><div class="tm-article-presenter__body" data-test-id="article-body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><!--[--><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><!--[--><div class="tm-article-presenter__header"><!--[--><!--]--><div class="article-snippet tm-article-presenter__snippet" data-v-085cd854><!--[--><!--]--><div class="meta-container" data-v-085cd854><div class="meta" data-v-085cd854><span class="tm-user-info author" data-v-085cd854><a href="/ru/users/abrca/" class="tm-user-info__userpic" data-test-id="user-info-pic"><!--[--><div class="tm-entity-image"><!--[--><!--]--></div><!--]--></a><span class="tm-user-info__user tm-user-info__user_appearance-default" data-test-id="user-info-description"><a href="/ru/users/abrca/" class="tm-user-info__username" data-test-id="user-info-username"><!--[-->abrca<!--]--></a><!----><!--[--><span class="tm-article-datetime-published" data-v-085cd854><time data-allow-mismatch datetime="2016-10-17T16:24:28.000Z" title="2016-10-17, 16:24">17  окт  2016 в 16:24</time></span><!--]--></span></span></div><div class="controls" data-v-085cd854><!----><!----><!----><!----></div></div><h1 class="tm-title tm-title_h1" lang="ru" data-test-id="articleTitle" data-v-085cd854><span>Настройка выделенного сервера Source под Linux, часть 4</span></h1><div class="stats" data-test-id="articleStats" data-v-085cd854><!----><div class="tm-article-reading-time" data-v-085cd854><span class="tm-svg-icon__wrapper tm-article-reading-time__icon"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Время на прочтение</title><use xlink:href="/img/megazord-v28.cba4c116..svg#clock"></use></svg></span><span class="tm-article-reading-time__label">24 мин</span></div><span class="tm-icon-counter tm-data-icons__item reach-counter" data-v-085cd854><svg class="tm-svg-img tm-icon-counter__icon" height="24" width="24"><title>Охват и читатели</title><use xlink:href="/img/megazord-v28.cba4c116..svg#counter-views"></use></svg><span class="tm-icon-counter__value" title="9255">9.3K</span></span></div><div class="tm-publication-hubs__container" data-test-id="articleHubsList" data-v-085cd854><div class="tm-publication-hubs"><!--[--><span class="tm-publication-hub__link-container"><a href="/ru/hubs/nix/" class="tm-publication-hub__link"><!--[--><span>*nix</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб"> * </span><!--]--></a></span><!--]--></div></div><div class="tm-article-labels" data-test-id="articleLabels" data-v-085cd854 data-v-bfa2437b><div class="tm-article-labels__container" data-v-bfa2437b><!----><!--[--><div class="tm-publication-label tm-publication-label_variant-tutorial" data-v-bfa2437b><span>Туториал</span></div><!--[--><!--]--><!--]--></div></div><!----><!----><!--teleport start--><!--teleport end--></div></div><!--[--><!----><div class="article-body" data-gallery-root lang="ru" data-v-aad06d04><div data-v-aad06d04><!--[--><!--]--></div><div id="post-content-body" data-v-aad06d04><div><div class="article-formatted-body article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><ul>
<li>Сервер статистики HLstatsX<br/>
<ul>
<li>Установка</li>
<li>Настройка mysql</li>
<li>Настройка HLstatsX демона</li>
<li>Настройка веб-сервера</li>
<li>Трансляция логов</li>
<li>Патч</li>
<li>Первый запуск</li>
<li>Регистрация серверов</li>
<li>Начальная настройка</li>
<li>Ошибки</li>
<li>Тепловые карты</li>
<li>Автоматический запуск</li>
<li>Тюнинг<br/>
<ul>
<li>Шрифты</li>
<li>Превью карты</li>
<li>Раздельный учёт статистики</li>
<li>Отключение статистики</li>
<li>Ограничение доступа</li>
<li>Новое оружие</li>
<li>Восстановление пароля</li>
</ul></li>
</ul></li>
</ul><a name="habracut"></a><br/>
<h1 id="server-statistiki-hlstatsx">Сервер статистики HLstatsX</h1><br/>
<p>Было бы несправдливым не осветить мельком сервер статистики HLstatsX Community Edition (HLstatsX:CE). Проект сейчас развивается не очень активно, последняя стабильная версия — 1.6.19 от 2014 года. Можно установить её, а можно текущую версию, на момент написания, отличающуюся непринципиальными правками. Всё равно придётся допиливать.</p><br/>
<p>Нам ещё понадобится sql сервер (mysql/mariadb), веб сервер (nginx), perl и php с некоторыми модулями. Так же на наших игровых серверах уже должны быть установлены MetaMod и SourceMod.</p><br/>
<h2 id="ustanovka">Установка</h2><br/>
<p>Текущий репозиторий — <a href="https://bitbucket.org/Maverick_of_UC/hlstatsx-community-edition/">https://bitbucket.org/Maverick_of_UC/hlstatsx-community-edition/</a></p><br/>
<p>Скачиваем текущую версию:</p><br/>
<pre><code class="bash">   $ wget https://bitbucket.org/Maverick_of_UC/hlstatsx-community-edition/get/master.tar.bz2
   $ mkdir ~/stat
   $ tar -jxvf master.tar.bz2 -C ~/stat --strip 1</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>HLstatsX состоит из трёх логических частей — транслирующего игровые события SourceMod плагина, получающего их демона, и отображающей веб-части.</p><br/>
<p>Статистика будет собираться следующим образом:</p><br/>
<ul>
<li>Игровые сервера со специальными SourceMod плагинами транслирует по udp расширенные логи игры на 192.0.2.0:27500 (сервер No 1) и 192.0.2.0:27501 (сервер No 2)</li>
<li>Демон HLstatsX получает логи, слушая на указанных адресах и пишет информацию в общую sql базу.</li>
<li>Веб-интерфейс HLstatsX на её основе рисует красивую (или не очень) статистику.</li>
</ul><br/>
<p>Переходим в каталог ~/stat. Там мы видим подкаталоги</p><br/>
<p><code>amxmodx</code> — плагины для AMX Mod X<br/>
<code>heatmaps</code> — скрипты для построения тепловых карт<br/>
<code>scripts</code> — скрипты демона<br/>
<code>sourcemod</code> — плагины для SourceMod<br/>
<code>sql</code> — скрипт для создания sql базы данных<br/>
<code>web</code> — веб-интерфейс.</p><br/>
<p>В подкаталогах amxmodx и sourcemod находятся плагины для AMX Mod X и SourceMod соответственно. Так как AMX Mod X мы не используем, то содержимое amxmodx нам не актуально, в отличие от sourcemod, в котором находится плагины статистики в исходниках (sourcemod/scripting) и в скомпилированном виде (sourcemod/plugins). Теоретически могут быть проблемы, когда версия SourceMod, установленная у нас сильно отличается от той, под которой скомпилирован плагин, поэтому мы скопируем исходники плагинов hlstatsx.sp и superlogs-tf2.sp в каталог scripting первого сервера и перекомпилируем их:</p><br/>
<pre><code class="bash">   $ cp ~/stat/sourcemod/scripting/{hlstatsx.sp,superlogs-tf2.sp} ~/tf2/tf/addons/sourcemod1/scripting
   $ cp ~/stat/sourcemod/scripting/include/* ~/tf2/tf/addons/sourcemod1/scripting/include
   $ cd ~/tf2/tf/addons/sourcemod1/scripting</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Во избежание ошибки при компиляции, поправим файл:</p><br/>
<pre><code class="bash">   $ sed -i -e s/char/char1/g ~/tf2/tf/addons/sourcemod1/scripting/hlstatsx.sp</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Компилируем и раскладываем по каталогам:</p><br/>
<pre><code class="bash">   $ ./compile.sh hlstatsx.sp superlogs-tf2.sp
   $ cp compiled/hlstatsx.smx compiled/superlogs-tf2.smx ~/tf2/tf/addons/sourcemod1/plugins
   $ mv compiled/hlstatsx.smx compiled/superlogs-tf2.smx ~/tf2/tf/addons/sourcemod2/plugins</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Если игровые сервера уже запущены, то в их консолях вводим (команды выделены угловыми скобками):</p><br/>
<pre><code>   &gt;&gt;&gt; sm plugins refresh
   [SM] The plugin list has been refreshed and reloaded.
   &gt;&gt;&gt; sm plugins list
   [SM] Listing 19 plugins:
   [...]
   18 "SuperLogs: TF2" (2.0.32) by Thomas "CmptrWz" Berezansky &amp; psychonic
   19 "HLstatsX CE Ingame Plugin" (1.6.19) by psychonic</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Хорошо. В принципе игроки уже могут вызвать HLstatsX плагин, введя в окне чата "hlx_menu". Правда пока без особого эффекта. Настройки этих плагинов (да и не только этих) осуществляются через их консольные переменные — ConVars, как правило путём прописывания в файлах конфигурации сервера, либо конкретной карты. Их перечень обычно есть в документации, но при желании можно посмотреть самим:</p><br/>
<pre><code class="bash">   $ grep CreateConVar ~/tf2/tf/addons/sourcemod1/scripting/hlstatsx.sp
   $ grep CreateConVar ~/tf2/tf/addons/sourcemod1/scripting/superlogs-tf2.sp</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Обнаруживаем, что superlogs_headshots по умолчанию выключен. Если нужна регистрация хедшотов, то добавляем "superlogs_headshots 1" в любой файл конфигурации, а для уже запущенного сервера выполняем эту же команду в консоли.</p><br/>
<h2 id="nastroyka-mysql">Настройка mysql</h2><br/>
<p>Сервер mysql (mariadb) у нас уже установлен, настроен и запущен, поэтому сразу переходим к созданию базы данных для сервера статистики. Переходим в ~/stat/sql (где должен лежать install.sql), вспоминаем пароль администратора для mysql, запускаем клиента:</p><br/>
<pre><code class="bash">   $ cd ~/stat/sql
   $ mysql --user=root mysql --password</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Создаём базу данных и пользователя с паролем:</p><br/>
<pre><code>   Enter password:
   Welcome to the MariaDB monitor.  Commands end with ; or \g.
   Your MariaDB connection id is 1513
   Server version: 5.5.47-MariaDB-log MariaDB Server

   Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.

   Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

   MariaDB [mysql]&gt; CREATE DATABASE hlx_db;
   Query OK, 1 row affected (0.02 sec)

   MariaDB [mysql]&gt; GRANT ALL PRIVILEGES ON hlx_db.* TO hlx_user@localhost IDENTIFIED BY 'hlx_password' WITH GRANT OPTION;
   Query OK, 0 rows affected (0.00 sec)

   MariaDB [mysql]&gt; FLUSH PRIVILEGES;
   Query OK, 0 rows affected (0.00 sec)

   MariaDB [mysql]&gt; QUIT;
   Bye</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>База данных создана, теперь удаляем ~/.mysql_history, с нескромно зафиксированным паролем от hlx_user, запускаем скрипт, создающий необходимые таблицы. При запросе вводим пароль от нашей базы данных — 'hlx_password'.</p><br/>
<pre><code class="bash">   $ rm -f ~/.mysql_history
   $ mysql --user=hlx_user hlx_db --password &lt; ~/stat/sql/install.sql</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<pre><code>   Enter password:
   Table                 Op         Msg_type  Msg_text
   hlx_db.hlstats_Ranks  optimize   status    OK</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Всё, база данных создана</p><br/>
<blockquote>В процессе настройки, для серфинга по sql таблицам, анализа проблем и удаления результатов неудачных экспериментов может пригодиться <a href="http://www.adminer.org">Adminer</a> — компактная, но мощная web-панель управления, состоящая всего лишь из одного php скрипта. Если у вас не установлен phpMyAdmin или что иное, то этот Adminer — отличный вариант.</blockquote><br/>
<h2 id="nastroyka-hlstatsx-demona">Настройка HLstatsX демона</h2><br/>
<p>В каталоге ~/stat/scripts находятся основные скрипты демона сервера статистики. Редактируем файл настроек ~/stat/scripts/hlstats.conf, прописываем параметры соединения с sql сервером:</p><br/>
<pre><code>   DBHost "localhost"
   DBUsername "hlx_user"
   DBPassword "hlx_password"
   DBName "hlx_db"</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>В секции UDP Socket Settings мы ничего не трогаем. Если бы у нас был один игровой сервер, то там прописали бы адрес и порт, указанный в logaddress_add в server.cfg. Но так как мы настраиваем два сервера, то параметр BindIP оставляем пустым, а номера портов будем указывать в командной строке при запуске демона.</p><br/>
<p>В файле ~/stat/scripts/run_hlstats исправляем каталог для логов:</p><br/>
<pre><code>   LOGDIR=/home/game/log/hlstats</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Устанавливаем базу данных GeoIP. Она пригодится как для вывода на экран во время игры сообщений вида "Вошёл игрок такой-то из страны такой-то", так и для отображения статистики на сайте. Запускаем программу <code>cal</code>, проверяем, какой первый день недели в её выдаче. Локаль у нас везде en_US, поэтому cal показывает воскресенье. Переходим в каталог ~/stat/scripts/GeoLiteCity и редактируем файл GeoLite_Import.sh:</p><br/>
<pre><code>   # Set this value to 1 if you are running Gentoo linux, or any other linux distro
   # where the "cal" command outputs not Sunday as the first day in every row!
   LINUX_OTHER="0"

   # Login information for your MySQL server
   DBHOST="localhost"
   DBNAME="hlx_db"
   DBUSER="hlx_user"
   DBPASS="hlx_password"</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Делаем скрипт GeoLite_Import.sh исполняемым и запускаем его. База GeoIP скачается и импортируется в sql базу. При успешном импорте выдаётся что-то вида:</p><br/>
<pre><code>   [...]
   hlx_db.geoLiteCity_Blocks: Records: 2359593  Deleted: 0  Skipped: 0  Warnings: 0
   hlx_db.geoLiteCity_Location: Records: 793056  Deleted: 0  Skipped: 0  Warnings: 793056</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Как вариант, можно GeoIP данные хранить в отдельном файле (для этого используется скрипт install_binary.sh — но тогда необходимо установить (если его нет) perl модуль Geo::IP::PurePerl — <code>perl -MCPAN -e 'install Geo::IP::PurePerl</code>. Но мы будем хранить GeoIP данные внутри нашей sql базы. Не такая уж высокая нагрузка на неё ожидается.</p><br/>
<h2 id="nastroyka-veb-servera">Настройка веб-сервера</h2><br/>
<p>Сервер статистики у нас будет по адресу <a href="http://stat.example.org/">http://stat.example.org/</a>. Как и в случае с настройкой Fast Download, создадим отдельный каталог /var/www/stat.example.org. Логи access_log и error.log тоже вынесем в отдельные файлы и предоставим возможность пользователю game читать их.</p><br/>
<p>Сервер статистики будет обслуживать оба наших игровых сервера. Из-под root создаём каталоги, переносим каталог ~/stat/web, устанавливаем владельца и права. Создаём логи. Можно заодно сделать символьные ссылки для удобства.</p><br/>
<pre><code class="dos">   # mkdir -p /var/www/stat.example.org/{htdocs,log}
   # mv /home/game/stat/web/* /var/www/stat.example.org/htdocs
   # chown -R game. /var/www/stat.example.org/htdocs
   # touch /var/www/stat.example.org/log/{access,error}.log
   # chmod 644 /var/www/stat.example.org/log/*.log
   # ln -s /var/www/stat.example.org/log /home/game/log/www-stat</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>В настоящее время HLstatsX развивается мягко говоря не то чтоб активно, поэтому частых обновлений не прогнозируется, и нет особого смысла давать пользователю nginx полный доступ к его файлам для работы встроенной функции автообновления.</p><br/>
<p>С целью уменьшения нагрузки сервер статистики создаёт небольшой кеш в папке hlstatsimg/progress — там хранятся графики загрузки игровых серверов и графики Player Trend (видны на страницах игроков), поэтому надо веб-серверу дать возможность записи в этот каталог:</p><br/>
<pre><code class="dos">   # chown nginx. /var/www/stat.example.org/htdocs/hlstatsimg/progress</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Переходим в /var/www/stat.example.org/htdocs, редактируем config.php, предварительно сделав <code>dos2unix config.php</code>:</p><br/>
<pre><code>   define("DB_ADDR", "localhost");
   define("DB_USER", "hlx_user");
   define("DB_PASS", "hlx_password");
   define("DB_NAME", "hlx_db");</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Другие параметры пока не трогаем.</p><br/>
<p>Пока мы ещё root, создаём файл конфигурации /etc/nginx/conf.d/stat.example.org.conf нашего веб-сервера для этого поддомена.</p><br/>
<div class="spoiler"><b class="spoiler_title">stat.example.org.conf</b><div class="spoiler_text"><pre><code>server
{
    server_name                 stat.example.org;
    listen                      80;
    root                        /var/www/stat.example.org/htdocs;

    # Этот rewrite понадобится нам позже, в настройках
    rewrite                     sig-(.*)-(.*).png$ /sig.php?player_id=$1&amp;background=$2 break;

    location /
    {
        try_files               $uri $uri/ /index.php$request_uri;
    }

    # Отрабатываем .htaccess файлы, закрывающие доступ к каталогу pages, pages/admintasks, pages/ingame
    location ~ /\.ht
    {
        deny  all;
    }

    # Зависит от вашего способа подключения php
    location ~ ^.+\.php(?:/.*)?$
    {
        include                 /etc/nginx/php.conf;
        fastcgi_pass            unix:/var/run/php5-fpm.sock;
    }

    access_log                  /var/www/stat.example.org/log/access.log main;
    error_log                   /var/www/stat.example.org/log/error.log warn;
}</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Выше мы дали пользователю game доступ на чтение логов веб-сервера, но лишь до первой их ротации. Исправляем и это. На основе /etc/logrotate.d/nginx создаём файл srcds-nginx, прописываем путь к логам и исправляем маску прав доступа с 640 на 644 в строчке <code>create 640 nginx adm</code>:</p><br/>
<div class="spoiler"><b class="spoiler_title">srcds-nginx</b><div class="spoiler_text"><pre><code>#/etc/logrotate.d/srcds-nginx

/var/www/stat.example.org/log/*.log
/var/www/fastdl.example.org/log/*.log
/var/www/replay.example.org/log/*.log
{
        daily
        missingok
        rotate 52
        compress
        delaycompress
        notifempty
        create 644 nginx adm
        sharedscripts
        postrotate
                if [ -f /var/run/nginx.pid ]; then
                        kill -USR1 `cat /var/run/nginx.pid`
                fi
        endscript
}</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Здесь мы в путях для ротации указали заодно каталоги с логами от серверов с записями и с Fast Download.</p><br/>
<p>Проверяем корректность конфигурации и перезапускаем веб-сервер.</p><br/>
<pre><code class="dos">   # nginx -t
   # systemctl reload nginx</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Далее продолжаем как пользователь game.</p><br/>
<h2 id="translyaciya-logov">Трансляция логов</h2><br/>
<p>Трансляцию логов мы должны были включить ещё на этапе настройки, в файлах конфигурации наших серверов. На всякий случай проверяем наличие в них параметров "log on" и "logaddress_add &lt;...&gt;".</p><br/>
<h2 id="patch">Патч</h2><br/>
<p>Перед запуском скриптов нам придётся их немного поправить. Дело в том, что с 2014 года стала использоваться новая версия записи идентификатора Steam. Предыдущая, вторая, имела вид STEAM_0:1:12345678, а нынешняя третья — [U:1:12345678]. Но текущая версия HLstatsX (1.6.19) новую версию идентификатора не понимает, что добавляет кривизну в статистику. Для недопущения этого мы внесём несколько изменений в скрипты, которые будут новую версию steamid3 конвертировать в старую, steamid2. Патч взят с <a href="https://forums.alliedmods.net/showthread.php?t=246712">forums.alliedmods.net</a>. Сохраняем нижеследующее в файл и запускаем.</p><br/>
<div class="spoiler"><b class="spoiler_title">idpatch.sh</b><div class="spoiler_text"><pre><code>#!/bin/sh

uudecode -o ~/idpatch &lt;&lt; EOF
begin-base64 664 idpatch
ZGlmZiAtTmF1cnAgc2NyaXB0cy9ITHN0YXRzX0V2ZW50SGFuZGxlcnMucGxp
YiBzY3JpcHRzLmZpeGVkL0hMc3RhdHNfRXZlbnRIYW5kbGVycy5wbGliCi0t
LSBzY3JpcHRzL0hMc3RhdHNfRXZlbnRIYW5kbGVycy5wbGliCTIwMTYtMDct
MzAgMDI6NTE6NDUuMDAwMDAwMDAwICswNTAwCisrKyBzY3JpcHRzLmZpeGVk
L0hMc3RhdHNfRXZlbnRIYW5kbGVycy5wbGliCTIwMTYtMTAtMTIgMTc6MDg6
MjcuNDM0NDA0MzczICswNTAwCkBAIC0xNTk0LDYgKzE1OTQsNyBAQCBzdWIg
ZG9FdmVudF9QbGF5ZXJBY3Rpb24KIAkJCQlteSAkb3duZXJzdHJpbmcgPSAi
IjsKIAkJCQlpZiAoZGVmaW5lZCgkcHJvcGVydGllc3tvYmplY3Rvd25lcn0p
KSB7CiAJCQkJCW15ICRvd25lciA9ICRwcm9wZXJ0aWVze29iamVjdG93bmVy
fTsKKwkJCQkJJG93bmVyID1+IHMhXFtVOjE6KFxkKylcXSEnU1RFQU1fMDon
LigkMSAlIDIpLic6Jy5pbnQoJDEgLyAyKSFlZzsKIAkJCQkJJG93bmVyID1+
IC8uKz88U1RFQU1fWzAtOV0rOihbMC05XSs6WzAtOV0rKT4uKi87CiAJCQkJ
CSRvd25lciA9ICQxOwogCQkJCQlpZiAoJG93bmVyIGVxICRwbGF5ZXItPnt1
bmlxdWVpZH0pIHsKZGlmZiAtTmF1cnAgc2NyaXB0cy9obHN0YXRzLnBsIHNj
cmlwdHMuZml4ZWQvaGxzdGF0cy5wbAotLS0gc2NyaXB0cy9obHN0YXRzLnBs
CTIwMTYtMDctMzAgMDI6NTE6NDUuMDAwMDAwMDAwICswNTAwCisrKyBzY3Jp
cHRzLmZpeGVkL2hsc3RhdHMucGwJMjAxNi0xMC0xMiAxNzowOTowNS4wODA4
ODc1MDkgKzA1MDAKQEAgLTEwNjEsNiArMTA2MSw3IEBAIHN1YiBnZXRQbGF5
ZXJJbmZvCiAJCW15ICRoYXZlcGxheWVyICA9IDA7CiAJCQogCQkkcGxhaW51
bmlxdWVpZCA9ICR1bmlxdWVpZDsKKwkJJHVuaXF1ZWlkID1+IHMhXFtVOjE6
KFxkKylcXSEnU1RFQU1fMDonLigkMSAlIDIpLic6Jy5pbnQoJDEgLyAyKSFl
ZzsKIAkJJHVuaXF1ZWlkID1+IHMvXlNURUFNX1swLTldKz9cOi8vOwogCQkK
IAkJaWYgKCgkdW5pcXVlaWQgZXEgIkNvbnNvbGUiKSAmJiAoJHRlYW0gZXEg
IkNvbnNvbGUiKSkgewpkaWZmIC1OYXVycCBzY3JpcHRzL1RSY29uLnBtIHNj
cmlwdHMuZml4ZWQvVFJjb24ucG0KLS0tIHNjcmlwdHMvVFJjb24ucG0JMjAx
Ni0wNy0zMCAwMjo1MTo0NS4wMDAwMDAwMDAgKzA1MDAKKysrIHNjcmlwdHMu
Zml4ZWQvVFJjb24ucG0JMjAxNi0xMC0xMiAxNzowOTozMC42OTk4NTUzMTkg
KzA1MDAKQEAgLTMzOCw2ICszMzgsNyBAQCBzdWIgZ2V0UGxheWVycwogICAg
ICAgbXkgJGFkZHJlc3MgID0gJDg7CiAgICAgICBteSAkcG9ydCAgICAgPSAk
OTsKIAorCSAgJHVuaXF1ZWlkID1+IHMhXFtVOjE6KFxkKylcXSEoJDEgJSAy
KS4nOicuaW50KCQxIC8gMikhZWc7CiAJICAkdW5pcXVlaWQgPX4gcy9eU1RF
QU1fWzAtOV0rP1w6Ly9pOwogCSAgCiAgICAgICAjICY6OnByaW50RXZlbnQo
IkRFQlVHIiwgIlVTRVJJRDogJyR1c2VyaWQnLCBOQU1FOiAnJG5hbWUnLCBV
TklRVUVJRDogJyR1bmlxdWVpZCcsIFRJTUU6ICckdGltZScsIFBJTkc6ICck
cGluZycsIExPU1M6ICckbG9zcycsIFNUQVRFOiAnJHN0YXRlJywgQUREUkVT
UzonJGFkZHJlc3MnLCBDTElfUE9SVDogJyRwb3J0JyIsIDEpOwo=
====
EOF

patch --backup --directory ~/stat/scripts &lt; ~/idpatch

rm -f ~/idpatch</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Ну либо ручками по статье с форума.</p><br/>
<h2 id="pervyy-zapusk">Первый запуск</h2><br/>
<p>Итак, у нас должно быть всё готово:</p><br/>
<ul>
<li>nginx запущен (и, если исправляли файлы конфигурации, то перезапущен)</li>
<li>mysql запущен (база данных и таблицы созданы)</li>
<li>демон HLstatsX настроен (~/stat/scripts/hlstats.conf), но не запущен</li>
<li>веб-интерфейс подготовлен (/var/www/stat.example.org/htdocs/config.php)</li>
<li>необходимые perl/php модули установлены</li>
<li>база данных GeoIP импортирована.</li>
</ul><br/>
<p>Осталось настроить запуск демона. Возвращаемся в ~/stat. В принципе, там можно удалить ненужные уже каталоги amxmodx, sourcemod, sql, web. Оставим только heatmaps и scripts. В каталоге ~/stat/scripts файлы <code>*.pl</code> и <code>run_*</code> должны быть с атрибутом "исполняемый":</p><br/>
<pre><code class="bash">   $ chmod +x ~/stat/scripts/*.pl ~/stat/scripts/run_*</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Запускаем оба игровых сервера (если не запущены ранее).</p><br/>
<p>Файл ~/stat/scripts/run_hlstats — это демон, получающий статистику от игровых серверов и записывающий её в sql базу. Запуск его без параметров показывает допустимые параметры запуска — start, stop, restart и другие. Для нашей конфигурации параметры его запуска таковы: <code>run_hlstats start &lt;количество демонов&gt; &lt;первый порт&gt; &lt;шаг увеличения номера порта&gt;</code> — именно поэтому в настройках наших игровых серверов, в параметрах logaddress_add номера портов должны идти последовательно — 27500 для первого сервера и 27501 для второго. Стартуем.</p><br/>
<pre><code class="bash">   $ ~/stat/scripts/run_hlstats start 2 27500 1</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>На экране должно появиться что-то типа:</p><br/>
<pre><code>   HLstatsX:CE daemon control
   http://www.hlxce.com
   ---------------------------
   Attempting to start HLstatsX:CE daemon on port 27500...
   Daemon successfully started on port 27500
   Attempting to start HLstatsX:CE daemon on port 27501...
   Daemon successfully started on port 27501</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>А в каталоге ~/log/hlstats образовались два файла с логами (для каждого демона свой). Смотрим первый лог:</p><br/>
<pre><code>   2014-01-24 14:24:16:  - MYSQL: Connecting to MySQL database 'hlx_db' on 'localhost' as user 'hlx_user' ... connected ok
   2014-01-24 14:24:16:  - CONFIG: Reading database config...
   2014-01-24 14:24:16:  - CONFIG: I have found the following server configs in database:
   2014-01-24 14:24:16:  - ERROR: GeoIP method set to binary file lookup but .//GeoLiteCity/GeoLiteCity.dat NOT FOUND
   2014-01-24 14:24:16:  - HLSTATSX: HLstatsX:CE 1.6.19 starting...
   2014-01-24 14:24:16:  - UDP: Opening UDP listen socket on port 27500 ... ok
   2014-01-24 14:24:16:  - HLSTATSX: Maximum Skill Change on all servers are 25 points
   2014-01-24 14:24:16:  - HLSTATSX: Tracking Trend of the stats are enabled
   2014-01-24 14:24:16:  - HLSTATSX: Minimum Skill Change on all servers are 2 points
   2014-01-24 14:24:16:  - HLSTATSX: Minimum Players Kills on all servers are 50 kills
   2014-01-24 14:24:16:  - HLSTATSX: Players chat logging is enabled
   2014-01-24 14:24:16:  - HLSTATSX: Broadcasting public chat is disabled
   2014-01-24 14:24:16:  - HLSTATSX: Event queue size is set to 10
   2014-01-24 14:24:16:  - HLSTATSX: HLstatsX:CE is now running (Normal mode, debug level 1)</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Ругань про GeoIP — это нормально, позже мы укажем серверу статистики что информация хранится в базе данных, а не во внешнем файле.</p><br/>
<p>Теперь необходимо обеспечить какую-нибудь движуху на наших игровых серверах — чтобы что-то писалось в логи. Проще всего самому присоединиться к серверу. Если при этом в логах всё равно раз в две минуты начинает появляться</p><br/>
<pre><code>   2014-01-24 15:21:33:  - HLSTATSX: No data since 120 seconds
   2014-01-24 15:23:33:  - HLSTATSX: No data since 120 seconds</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>то или игровой сервер не запущен (или запущен но не тот или не так) или что-то с настройками — в первую очередь ip:port (если вы в настройках сервера, в logaddress_add указали ip 127.0.0.1, то попробуйте исправить его на внешний), во вторую очередь — включены ли у нас логи вообще, если да, то куда они транслируются. Ну и нельзя исключать влияние злых сил — того же файервола. При корректных настройках, запуск <code>netstat -lpn | grep perl</code> должен вывести что-то вида:</p><br/>
<pre><code>   udp     0      0 0.0.0.0:27500      0.0.0.0:*                 15855/perl
   udp     0      0 0.0.0.0:27501      0.0.0.0:*                 15861/perl</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Если же после подключения к серверу, в логе побежали строчки:</p><br/>
<pre><code>   2014-01-24 15:39:37: 192.0.2.0:27015 - E997: NOT ALLOWED SERVER: кракозябры 01/24/2014 - 15:39:39: "Ich&lt;4&gt;&lt;[U:1:123456789]&gt;&lt;&gt;" connected, address "198.51.100.0:44098"
   2014-01-24 15:39:39: 192.0.2.0:27015 - E997: NOT ALLOWED SERVER: кракозябры 01/24/2014 - 15:39:39: "Ich&lt;4&gt;&lt;[U:1:123456789]&gt;&lt;&gt;" STEAM USERID validated</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>То это хорошо. HLstatsX получает логи от сервера, но так как мы ещё не настроили сам сервер статистики — в частности, не зарегистрировали там наш игровой сервер, то он его не признаёт.</p><br/>
<p>В случае возникновения ошибок вида "Can't setup UDP socket on port 27500: Address already in use" для определения виновника используем утилиту <code>netstat -lpn</code></p><br/>
<p>Итак, с самым интересным закончили, переходим теперь к настройке сервера статистики.</p><br/>
<h2 id="registraciya-serverov">Регистрация серверов</h2><br/>
<p>Открываем в браузере наш сервер — <a href="http://stat.example.org/">http://stat.example.org/</a></p><br/>
<p>На экране предупреждение о проверке обновления, кликаем по ссылке <a href="http://stat.example.org/hlstats.php?mode=updater">HLX:CE Database Updater</a>, видим уведомление о том, что "Your database is already up to date (78)", удаляем папку updater:</p><br/>
<pre><code class="bash">   $ rm -rf /var/www/stat.example.org/htdocs/updater</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Снова переходим на <a href="http://stat.example.org/">http://stat.example.org/</a>, видим гуглокарту и в самом низу страницы кликаем по ссылке "[Admin]", вводим логин и пароль по умолчанию, admin: 123456. Первым делом переходим General Settings -&gt; Admin Users. Меняем пароль администратора и, по желанию, его логин. [Apply]. Затем начинаем не торопясь настраивать.</p><br/>
<p>Регистрируем наши сервера. Переходим в Game Settings -&gt; Team Fortress 2 (tf) -&gt; Add Server, вводим данные для первого сервера:</p><br/>
<p><code>Server IP Address:</code><br/>
IP нашего сервера — 192.0.2.0<br/>
<code>Server Port:</code><br/>
порт сервера — 27015 — параметр '-port' из командной строки srcds_run<br/>
<code>Server Name:</code><br/>
можно оставить пустым, сам определит<br/>
<code>Rcon Password:</code><br/>
укажем тот же, что в rcon_password в настройках первого сервера<br/>
<code>Public Address:</code><br/>
оставляем пустым — он совпадает с Server IP Address<br/>
<code>Admin Mod:</code><br/>
у нас установлен только SourceMod, его и выбираем.</p><br/>
<p>Далее [Add Server], [Apply]. Перезапускаем демона — переходим по предлагаемой <a href="http://stat.example.org/hlstats.php?mode=admin&amp;task=tools_perlcontrol">ссылке</a>, уточняем номер порта — для первого сервера 27500, для второго 27501, нажимаем 'Execute'.</p><br/>
<p>Смотрим результат:</p><br/>
<pre><code>   HLstatsX: CE Daemon Control
      Sending Command to HLstatsX: CE Daemon at localhost:27500 — 50 bytes OK
      Waiting for Backend Answer...recieving 29 bytes in 1 packets...OK
      Backend Answer: OK, EXECUTING COMMAND: RELOAD
      Closing connection to backend...OK
   Return to Administration Center</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Если всё сделано правильно, то обновится лог первого демона <code>~/log/hlstats/hlstats_27500&lt;...&gt;</code>:</p><br/>
<pre><code>   2016-10-12 21:43:48:                 - PROXY, Reload request from 127.0.0.1:43992:
   2016-10-12 21:43:49:                 - CONTROL: Command received: RELOAD
   2016-10-12 21:43:49: 127.0.0.1:43992 - CONTROL: Sent 29 bytes to frontend at '127.0.0.1:43992'
   2016-10-12 21:43:49: 127.0.0.1:43992 - CONTROL: Re-Reading Configuration by request from Frontend...
   2016-10-12 21:43:49: 127.0.0.1:43992 - CONFIG: Reading database config...
   2016-10-12 21:43:49: 127.0.0.1:43992 - CONFIG: I have found the following server configs in database:
   2016-10-12 21:43:49: 127.0.0.1:43992 - S_CONFIG: 192.0.2.0:27015
   2016-10-12 21:43:49: 127.0.0.1:43992 - ERROR: GeoIP method set to binary file lookup but .//GeoLiteCity/GeoLiteCity.dat NOT FOUND
   2016-10-12 21:45:05:                 - HLSTATSX: Insert new server trend timestamp
   2016-10-12 21:45:47:                 - HLSTATSX: No data since 120 seconds
   2016-10-12 21:47:35: 192.0.2.0:27015 - SERVER: Connecting to rcon on 192.0.2.0:27015 ... ok
   2016-10-12 21:47:35: 192.0.2.0:27015 - TRCON: Trying to get rcon access (auth)
   2016-10-12 21:47:35: 192.0.2.0:27015 - TRCON: Junk packet from Source Engine
   2016-10-12 21:47:35: 192.0.2.0:27015 - TRCON: Rcon password accepted
   2016-10-12 21:47:36: 192.0.2.0:27015 - SERVER: Server running map: cp_granary
   2016-10-12 21:47:36: 192.0.2.0:27015 - SERVER: Ingame-URL: http://stat.example.org
   2016-10-12 21:47:36: 192.0.2.0:27015 - SERVER: Query results will displayed in valve browser
   2016-10-12 21:47:36: 192.0.2.0:27015 - SERVER: Showing stats is enabled
   2016-10-12 21:47:36: 192.0.2.0:27015 - SERVER: Broadcasting Live-Events with "hlx_sm_psay" is enabled</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Всё, первый сервер признан родным, rcon пароль верный, соединение установлено.</p><br/>
<p>Аналогично пропишем второй сервер.</p><br/>
<p><code>Server IP Address:</code><br/>
192.0.2.0<br/>
<code>Server Port:</code><br/>
27016 (!)<br/>
<code>Server Name:</code><br/>
пусто<br/>
<code>Rcon Password:</code><br/>
укажем тот же, что в rcon_password в настройках второго сервера<br/>
<code>Public Address:</code><br/>
пусто<br/>
<code>Admin Mod:</code><br/>
SourceMod</p><br/>
<p>Далее [Add Server], проверяем детали.</p><br/>
<p>Небольшой момент, который можем применить ко второму серверу. В период опытной эксплуатации, для проверки работы сервера статистики, его дальнейшей настройки и поиска возможных проблем, желательно чтобы велось накопление данных. Так как вряд ли стоит рассчитывать, что на наш свежий сервер как мухи слетятся 24 игрока, которые тут же начнут нам генерировать статистику, то придётся обойтись подручным материалом — ботами. Как населить карту молодыми, энергичными ботами рассказано в разделе "Боты", а пока при регистрации второго сервера, в окне перед окончательным "[Apply]" мы ищем параметр "IgnoreBots" и меняем его значение на "0". Тогда для второго игрового сервера боты будут учитываться как реальные игроки и по ним будет вестись статистика (ни о чём, но лишь бы была). Впоследствии, перед запуском в продуктив, мы всю статистику второго сервера обнулим и начнём жизнь с чистого листа. А пока будем считать, что на втором сервере у нас карта koth_sawmill, на которой бегают боты.</p><br/>
<p>Если же нравственный стержень внутри не позволяет опускаться до такого, то можно всё на этой же странице регистрации сервера изменить другой параметр, "MinPlayers", установив его в "1". По умолчанию, рейтинг у игроков начинает считаться, когда на карте не менее четырёх человек. Сделано это для уменьшения накруток на пустых картах, ну а сейчас мы снижаем порог до одного — себя.</p><br/>
<blockquote>Потом, когда потребуется вернуть всё обратно, в это окно мы можем попасть через раздел Game Settings — Team Fortress 2 (tf) — Edit Servers — (выбираем нужный сервер) — CONFIGURE — &gt;&gt; Server Details, возвращаем как было. Затем [Apply] и не забыть перезапустить демона.</blockquote><p>Теперь перезапустим демон HLstatsX для применения настроек по регистрации второго сервера. Можно через веб-интерфейс, не забыв указать другой порт — 27501, а можно ручками:</p><br/>
<pre><code class="bash">   $ ~/stat/scripts/run_hlstats reload</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<pre><code>   HLstatsX:CE daemon control
   http://www.hlxce.com
   ---------------------------
   Successfully reloaded daemon running on port 27500
   Successfully reloaded daemon running on port 27501</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>В браузере обновляем страницу <a href="http://stat.example.org/">http://stat.example.org/</a>, видим на главной странице оба наши сервера. Радуемся.</p><br/>
<p>Входим в игру, присоединяемся к нашему серверу. В окне чата ("y") вводим "hlx_menu". Появляется меню. Можно осваивать :-)</p><br/>
<h2 id="nachalnaya-nastroyka">Начальная настройка</h2><br/>
<p>Придадим нашему серверу минимально товарный вид. В интерфейсе администратора переходим в раздел General Settings -&gt; HLstatsX:CE Settings:</p><br/>
<p><code>Site Name</code><br/>
Имя нашего сервера статистики — HLstatsX at example.org</p><br/>
<p><code>Site URL</code><br/>
URL сервера статистики, который будет использоваться при генерации подписей для форумов — <a href="http://stat.example.org/">http://stat.example.org/</a></p><br/>
<p><code>Contact URL</code><br/>
Контактный адрес, e-mail либо url — game@example.org</p><br/>
<p><code>Use modrewrite to make forum signature image...</code><br/>
При установке в Disabled, игроку для ссылки на свою плашку придётся использовать код вида <a href="http://stat.example.org/sig.php?player_id=1&amp;amp;background=random">http://stat.example.org/sig.php?player_id=1&amp;background=random</a>. Но можно сделать этот url более красивым, установив данный параметр в Enabled и добавив строчку <code>rewrite sig-(.*)-(.*).png$ /sig.php?player_id=$1&amp;background=$2 break;</code> в файл конфигурации nginx для нашего сервера (что мы и сделали ранее при настройке веб-части). Тогда будут работать url вида <a href="http://stat.example.org/sig-1-random.png">http://stat.example.org/sig-1-random.png</a>.</p><br/>
<p><code>Choose whether to use GeoCityLite data...</code><br/>
Указываем местоположение GeoIP данных. Так как ранее мы определились что будем хранить их внутри нашей sql базы, то выбираем вариант "GeoIP lookup via database". Требует рестарта демонов run_hlstats.</p><br/>
<p><code>Map Download URL...</code><br/>
Указывает на путь, по которому можно скачать используемые карты. Если настроен Fast Download, то прописываем что-то вида <a href="http://fastdl.example.org/maps/%MAP%.bsp.bz2">http://fastdl.example.org/maps/%MAP%.bsp.bz2</a>. При корректной установке параметра, зайдя на сервер статистики в раздел Maps -&gt; <code>&lt;Имя карты&gt;</code>, на открывшейся странице справа появится неприметная ссылка "Download this map...", причём только для тех карт, которые наличествуют по этому url (сервер предварительно проверяет наличие карты). Но мы этот функционал использовать не будем. Потому что не сможем. При настройке Fast Download мы как раз-таки приложили усилия, чтобы никто не мог скачать карты "напрямую", без корректного referer.</p><br/>
<p>Всё? Ну тогда [Apply], и, так как меняли местоположение GeoIP данных, то перезапускаем обоих демонов.</p><br/>
<p>После окончательной настройки HLstatsX, когда все косяки настроек будут выявлены и исправлены, для уменьшения объёмов логов в ~/stat/scripts/logs, в файле конфигурации hlstats.conf параметр "DebugLevel" устанавливаем в "0".</p><br/>
<h2 id="oshibki">Ошибки</h2><br/>
<p>По окончании первоначальной настройки необходимо почитать лог ошибок веб-сервера — ~/log/www-stat/error.log. Типовые ошибки:</p><br/>
<pre><code>   PHP Fatal error:  Call to undefined function imagecreatetruecolor() in &lt;...&gt;/show_graph.php on line 194</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Необходимо установить библиотеку php-gd и перезапустить php, обслуживающий веб-сервер.</p><br/>
<pre><code>   PHP Fatal error:  Call to undefined function imageftbbox() in &lt;...&gt;/pChart.class on line 556</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Аналогично, не хватает freetype.</p><br/>
<pre><code>   PHP Warning:  imagepng(./hlstatsimg/progress/trend_123_4567890987.png): failed to open stream: Permission denied in /var/www/stat.example.org/htdocs/includes/pChart/pChart.class</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Забыли веб-серверу дать возможность записи в hlstatsimg/progress.</p><br/>
<pre><code>   PHP Warning:  session_start(): open(/var/lib/php/session/sess_m5ekot332e5k97au3a21hpqto6, O_RDWR) failed: No such file or directory (2)</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Проверяем наличие каталога /var/lib/php/session, он задаётся переменной "php_value[session.save_path]" в /etc/php-fpm.d/www.conf — при использовании php-fpm, конечно, и при отсутствии каталога создаём, из-под root:</p><br/>
<pre><code class="dos">   # mkdir /var/lib/php/session
   # chown nginx. /var/lib/php/session
   # chmod -R 700 /var/lib/php/session</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<h2 id="teplovye-karty">Тепловые карты</h2><br/>
<p>Теперь настроим генерацию тепловых карт. Со страницы загрузки <a href="https://bitbucket.org/Maverick_of_UC/hlstatsx-community-edition/downloads">https://bitbucket.org/Maverick_of_UC/hlstatsx-community-edition/downloads</a> из ветки dev / HLstatsX Community Edition / extras / HeatmapPack / скачиваем heatmap-src_3.zip </p><br/>
<pre><code class="bash">   $ wget https://bitbucket.org/Maverick_of_UC/hlstatsx-community-edition/raw/0577b45e5f33df4e2a6122077fa44902073a8844/extras/HeatmapPack/heatmap-src_3.zip
   $ unzip heatmap-src_3.zip tf/*.jpg -d ~/stat/heatmaps/src</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>В ~/stat/heatmaps/src появится каталог tf с кучей .jpg файлов — шаблонов для тепловых карт. Из 65 шаблонов, 32 соответствуют стандартным картам Team Fortress 2 (из почти сотни комплектных), а 33 — для пользовательских карт. Не идеал, но лучше чем ничего. В конце концов, ничто не мешает сделать недостающие самим.</p><br/>
<p>Переходим в ~/stat/heatmaps, редактируем файл config.inc.php. В переменных DB_ прописываем параметры соединения с базой данных, в HLXCE_WEB указываем корневой каталог нашего веб-сервера статистики — в котором находится каталог hlstatsimg. При желании, в OUTPUT_SIZE можно установить размер генерируемой карты в "large". Переменную DB_PREFIX не трогаем! Итак, как-то так:</p><br/>
<pre><code>   define('DB_HOST', 'localhost');
   define('DB_USER', 'hlx_user');
   define('DB_PASS', 'hlx_password');
   define('DB_NAME', 'hlx_db');
   define('HLXCE_WEB', '/var/www/stat.example.org/htdocs');
   define('HUD_URL', 'http://stat.example.org');</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Создаём каталог cache/tf — для хранения кеша</p><br/>
<pre><code class="bash">   $ mkdir -p ~/stat/heatmaps/cache/tf</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>На всякий случай проверяем, что у каталога /var/www/stat.example.org/htdocs/hlstatsimg/games/tf владелец game (либо он может туда писать).</p><br/>
<p>В файле heatmap.class.php меняем формат вывода даты на более привычный:</p><br/>
<pre><code class="bash">   $ sed -i -e s#"m/d/y"#"d M Y"#g ~/stat/heatmaps/heatmap.class.php
   $ sed -i -e s#"Y-m-d H:i:s"#"d M Y H:i:s P"#g ~/stat/heatmaps/heatmap.class.php</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Запускаем:</p><br/>
<pre><code class="bash">   $ ~/stat/heatmaps/generate.php</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Как мы условились выше, на втором сервере для тестирования статистики у нас была установлена карта koth_sawmill с ботами. Наш скрипт сейчас для неё создал тепловую карту (смотрим пятую строчку):</p><br/>
<pre><code>   25-07-2016 20:38:30   DB: Connected to hlx_db as hlx_user@localhost
   25-07-2016 20:38:31   IGNORE: Game: tf, Map: cp_warpath_v3, Kills: 0, (to few kills)
   25-07-2016 20:38:47   IGNORE: Game: tf, Map: cp_wolf2_b1, Kills: 0, (to few kills)
   25-07-2016 20:38:47   IGNORE: Game: tf, Map: koth_nucleus, Kills: 0, (to few kills)
   25-07-2016 20:38:47   CREATE: Game: tf, Map: koth_sawmill, Kills: 2014
   25-07-2016 20:39:24   IGNORE: Game: tf, Map: koth_viaduct, Kills: 0, (to few kills)
   25-07-2016 20:39:24   CREATE: Heatmap creation done.</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>А в каталоге /var/www/stat.example.org/htdocs/hlstatsimg/games/tf/heatmaps должны появиться два файла — koth_sawmill-kill.jpg и koth_sawmill-kill-thumb.jpg.</p><br/>
<p>Первоначальная генерация тепловой карты, как правило, достаточно продолжительна, но скрипт кеширует информацию и при последующих запусках всё работает гораздо быстрее. Теперь на сервере статистики переходим в раздел Maps, в строке с картой koth_sawmill, в самом правом столбце таблицы появилась иконка, при клике на которую открывается тепловая карта с номинацией TOTAL KILLS:</p><br/>
<p></p><br/>
<p>Данные для генерации карты берутся за последние тридцать дней. Этот период задаётся строкой <code>$timescope = (time() - 60*60*24*$mapinfo[$code][$map]['days']);</code> в heatmap.class.php, а, в свою очередь, столбец "days" в sql таблице hlstats_Heatmap_Config, для всех карт имеет значение "30".</p><br/>
<p>Если захочется поэкспериментировать со своими, самостоятельно сделанными шаблонами для тепловых карт, то следует иметь в виду, что недостаточно просто положить .jpg в каталог к остальным шаблонам. Необходимо ещё прописать параметры карты в таблице hlstats_Heatmap_Config нашей sql базы.</p><br/>
<h2 id="avtomaticheskiy-zapusk">Автоматический запуск</h2><br/>
<p>Теперь настраиваем запуск скриптов HLstatsX. У нас их аж пять:</p><br/>
<p><code>run_hlstats</code><br/>
запускает демонов, получающих логи с серверов;</p><br/>
<p><code>hlstats-awards.pl</code><br/>
многоцелевой скрипт, обсчитывающий статистику, работающий с геолокацией и умеющий оптимизировать sql базу данных;</p><br/>
<p><code>hlstats-resolve.pl</code><br/>
пытается по ip-адресам игроков определить доменные имена;</p><br/>
<p><code>GeoLite_Import.sh</code><br/>
скачивает и обновляет geoip базу;</p><br/>
<p><code>generate.php</code><br/>
создаёт тепловые карты.</p><br/>
<p>Все эти скрипты должны запускаться из-под пользователя game, поэтому их будем запускать из пользовательского crontab файла (его использование мы разрешили на этапе заведения пользователя), в котором у нас уже может быть прописан вызов скрипта для обновления серверов и для очистки каталогов с Записями. Запускаем <code>crontab -e</code>, добавляем:</p><br/>
<div class="spoiler"><b class="spoiler_title">crontab</b><div class="spoiler_text"><pre><code>*/5 * * * * cd $HOME/stat/scripts &amp;&amp; ./run_hlstats start 2 27500 1
1  0  * * * cd $HOME/stat/scripts &amp;&amp; ./hlstats-awards.pl
5  4  * * * cd $HOME/stat/scripts &amp;&amp; ./hlstats-resolve.pl
20 2 12 * * cd $HOME/stat/scripts/GeoLiteCity/ &amp;&amp; ./GeoLite_Import.sh
30 2 12 * * cd $HOME/stat/scripts &amp;&amp; ./hlstats-awards.pl --geoip
40 3 14 * * cd $HOME/stat/scripts &amp;&amp; ./hlstats-awards.pl --optimize
15 *  * * * cd $HOME/stat/heatmaps &amp;&amp; ./generate.php</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre></div></div><br/>
<p>Первая строка — каждые пять минут запускаем демона run_hlstats на случай скоропостижной кончины ранее запущенного. Если тот жив-здоров, то ничего страшного не произойдёт. Это официально рекомендуемый способ запуска.</p><br/>
<p>Вторая строка — раз в сутки запускаем скрипт hlstats-awards.pl, который со своими параметрами по умолчанию --inactive --awards --ribbons --prune подводит итоги и определяет героев дня.</p><br/>
<p>Третья строка — раз в сутки запускаем скрипт hlstats-resolve.pl, который по ip определяет имена хостов с которых заходили игроки и позволяет в админке, в Tools -&gt; Host Statistics посмотреть статистику по провайдерам. Запуск данного скрипта можно сделать более частым — он хотя и перелопачивает всю базу, но однажды определённые ip повторно не определяет.</p><br/>
<p>Четвёртая строка — раз в месяц обновляем базу GeoIP.</p><br/>
<p>Пятая строка — после обновления GeoIP, для ip-адресов в нашей базе с отсутствующей географической привязкой пытаемся заново определить местоположение.</p><br/>
<p>Шестая строка — раз в месяц запускаем оптимизацию sql базы данных.</p><br/>
<p>Седьмая — раз в час запускаем генерацию тепловых карт.</p><br/>
<p>Настройка перенаправления логов cron в лог, доступный пользователю game описана в разделе "Логи"</p><br/>
<h2 id="tyuning">Тюнинг</h2><br/>
<h3 id="shrifty">Шрифты</h3><br/>
<p>При формировании плашек игроков, как в примере ниже, используется шрифт DejaVu Sans, распространяющийся под свободной лицензией, но не способный похвастаться широким охватом символов Unicode, что приводит к невозвожности вывода на плашку, рядом с флагом, имени игрока в каком-нибудь экзотическим алфавите. Поэтому заменим его шрифтом <a href="https://en.wikipedia.org/wiki/Bitstream_Cyberbit">Bitstream Cyberbit</a> с подходящей для наших условий лицензией и с поддержкой гораздо большего количества символов.</p><br/>
<pre><code class="bash">   $ wget http://ftp.netscape.com/pub/communicator/extras/fonts/windows/Cyberbit.ZIP
   $ unzip Cyberbit.ZIP -d /var/www/stat.example.org/htdocs/hlstatsimg/sig/font/</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Использование DejaVuSans.ttf прописано в коде .php скриптов, поэтому либо переименовываем Cyberbit.ttf в DejaVuSans.ttf, либо правим скрипты:</p><br/>
<pre><code class="bash">   $ sed -i -e 's/DejaVuSans.ttf/Cyberbit.ttf/g' /var/www/stat.example.org/htdocs/*.php</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Корейские игроки могут быть довольны:</p><br/>
<p></p><br/>
<h3 id="prevyu-karty">Превью карты</h3><br/>
<p>Если пользователь на сервере статистики заходит в Maps -&gt; &lt;Имя карты&gt;, то для многих стандартных карт справа будет показано небольшое превью. Если нам хочется такое же для любимой пользовательской карты или для новой стандартной, то делаем красивый (это обязательно!) скриншот из игры, кадрируем, изменяем размер до 218x164 пикселя и сохраняем как &lt;имя карты&gt;.jpg в каталог /var/www/stat.example.org/htdocs/hlstatsimg/games/tf/maps. То есть для карты cp_orange_x3 создаём файл с превью cp_orange_x3.jpg и получаем следующее:</p><br/>
<p></p><br/>
<h3 id="razdelnyy-uchyot-statistiki">Раздельный учёт статистики</h3><br/>
<p>При стандартных настройках, в рамках одного типа игры (Team Fortress 2), учёт статистики ведётся общий для обоих серверов, то есть статистика по картам и рейтинг игроков считаются вне зависимости от того, на каком из наших двух игровых серверов они играют. Если есть желание разделить статистику, то в интерфейсе администратора, Tools -&gt; Duplicate Game settings копируем существующий тип игры "tf — Team Fortress 2" в новый. Предварительно необходимо предоставить веб-серверу право записи в каталог hlstatsimg/games: <code>chmod o+w /var/www/stat.example.org/htdocs/hlstatsimg/games</code>. Теперь при регистрации игровых серверов, в секции Game Settings вы сможете для каждого сервера выбирать разные типы игр.</p><br/>
<h3 id="otklyuchenie-statistiki">Отключение статистики</h3><br/>
<p>Если нам надо исключить игру на какой-то конкретной карте из попадания в статистику — ну мало ли, решили поэкспериментировать с пользовательскими achievement картами и не хочется пачкать статистику результатами наших гм… достижений, то в ~/cfg создаём файл &lt;имя карты&gt;.cfg (не забыв сделать потом символьную ссылку в ~/tf2/tf/cfg/) и содержимым:</p><br/>
<pre><code>   echo "*** &lt;имя карты&gt;.cfg"

   logaddress_delall</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Этот файл конфигурации выполнится при переходе на данную карту и игровой сервер не будет транслировать логи демону (на запись в ~/log/server2/ это не повлияет). А при следующей смене карт, перед переходом на новую карту будет выполнен файл конфигурации ~/cfg/server2.cfg, который включит трансляцию логов. При этом консольная переменная "hlx_protect_address" не должна быть установлена, иначе плагин сервера статистики будет блокировать эту команду.</p><br/>
<h3 id="ogranichenie-dostupa">Ограничение доступа</h3><br/>
<p>Если вы решите ограничить доступ к серверу статистики с помощью HTTP Basic Authentication по логину-паролю, то стоит иметь в виду, что при этом игроки лишатся возможности во время игры посмотреть свою статистику в motd окне, введя в чате "/hlx". Либо надо будет исключить из области аутентификации скрипт ingame.php и файлы .png, .gif, .css</p><br/>
<h3 id="novoe-oruzhie">Новое оружие</h3><br/>
<p>Настройка сервера статистики под конкретную игру осуществляется в разделе Game Settings, Team Fortress 2 (tf), секции Actions и Weapons. Там можно прописать действия и новые виды оружия, которые появились за годы, прошедшые с момента последнего релиза HLstatsX.</p><br/>
<h3 id="vosstanovlenie-parolya">Восстановление пароля</h3><br/>
<p>Если забыли логин или пароль администратора от сервера статистики HLstatsX, то их можно сбросить в исходные (admin:123456), тем же способом, каким мы изначально устанавливали. Если посмотреть в файле ~/stat/sql/install.sql, то там есть строчка</p><br/>
<pre><code>   INSERT INTO `hlstats_Users` VALUES ('admin','e10adc3949ba59abbe56e057f20f883e',100,0);</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>Вот её-то и сохраняем в отдельном файле, например reset_pwd.sql который и загружаем в sql базу:</p><br/>
<pre><code class="bash">   $ mysql --user=hlx_user hlx_db --password &lt; reset_pwd.sql</code><div class="code-explainer"><a href="https://sourcecraft.dev/" class="tm-button code-explainer__link" style="visibility: hidden;"></a></div></pre><br/>
<p>После чего заходим в админку сервера статистики с логином-паролем по умолчанию (admin:123456) и в General Settings -&gt; Admin Users меняем на своё.</p><br/>
<ul>
<li><a href="https://habrahabr.ru/post/312922/">Часть 1</a> — Установка клиента Steam и сервера Team Fortress 2, базовая настройка, обновления</li>
<li><a href="https://habrahabr.ru/post/312928/">Часть 2</a> — Записи (Replay), SourceTV, Fast Download, боты</li>
<li><a href="https://habrahabr.ru/post/312934/">Часть 3</a> — Установка MetaMod и SourceMod, скрипты запуска, логи, аккаунт Steam и <del>QuickPlay</del></li>
</ul></div></div></div><!----><!----></div><!----><!----></div><!--]--><!----><div class="tm-article-presenter__meta" data-test-id="article-meta-links"><div class="tm-separated-list tag-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span><ul class="tm-separated-list__list"><!--[--><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[srcds]" class="link"><span>srcds</span></a><!--]--></li><!--]--><!----></ul></div><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span><ul class="tm-separated-list__list"><!--[--><li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/nix/" class="link"><!--[--><span>*nix</span><!--]--></a><!--]--></li><!--]--><!----></ul></div></div><!----><!--]--></article><!--]--></div><!----></div><div style="" class="tm-article-sticky-panel" data-test-id="article-sticky-panel"><div class="tm-data-icons tm-data-icons tm-data-icons_space-big tm-article-sticky-panel__icons" data-test-id="article-stats-icons"><div class="article-rating tm-data-icons__item" data-v-b9b05a90><div class="tm-votes-meter votes-switcher" data-v-b9b05a90><svg class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon tm-votes-meter__icon_appearance-article" height="24" width="24"><title>Всего голосов 19: ↑13 и ↓6</title><use xlink:href="/img/megazord-v28.cba4c116..svg#counter-rating"></use></svg><span class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_appearance-article tm-votes-meter__value_rating tm-votes-meter__value" data-test-id="votes-meter-value" title="Всего голосов 19: ↑13 и ↓6">+5</span></div><!--teleport start--><!--teleport end--><!----></div><!----><!----><button class="bookmarks-button tm-data-icons__item" title="Добавить в закладки" type="button" data-v-861e2740><span class="tm-svg-icon__wrapper icon" data-v-861e2740><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Добавить в закладки</title><use xlink:href="/img/megazord-v28.cba4c116..svg#counter-favorite"></use></svg></span><span class="counter" title="Количество пользователей, добавивших публикацию в закладки" data-v-861e2740>73</span></button><div class="sharing tm-data-icons__item" title="Поделиться" data-v-daf6ee1d><button class="sharing-button" type="button" data-v-daf6ee1d><svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="icon" data-v-daf6ee1d><path fill="currentColor" d="M13.8 13.8V18l7.2-6.6L13.8 5v3.9C5 8.9 3 18.6 3 18.6c2.5-4.4 6-4.8 10.8-4.8z"></path></svg></button><!--teleport start--><!--teleport end--></div><div class="article-comments-counter-link-wrapper tm-data-icons__item" title="Читать комментарии" data-v-8d952463><a href="/ru/articles/312936/comments/" class="article-comments-counter-link" data-test-id="counter-comments" data-v-8d952463><!--[--><svg class="tm-svg-img icon" height="24" width="24" data-v-8d952463><title>Комментарии</title><use xlink:href="/img/megazord-v28.cba4c116..svg#counter-comments"></use></svg><span class="value" data-v-8d952463>3</span><!--]--></a><!----></div><!--[--><!--[--><!--[--><!----><!--]--><!--]--><!--]--><!--teleport start--><!--teleport end--><!----></div></div></div><!--[--><!--]--><div class="tm-article-presenter__footer"><!--[--><!--[--><div class="tm-article-blocks"><!----><!--[--><section class="tm-block tm-block tm-block_spacing-bottom"><!----><!--[--><div class="tm-block__body tm-block__body tm-block__body_variant-balanced"><!--[--><div class="article-author" data-test-id="article-author-info" data-async-called="true" data-v-af0d0f90><!--[--><!--]--><div class="tm-user-card tm-user-card tm-user-card_variant-article user-card" data-async-called="true" data-v-af0d0f90><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/abrca/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><!--[--><div class="tm-entity-image"><!--[--><!--]--></div><!--]--></a><div class="tm-user-card__meta"><div class="tm-counter-container karma" title=" 17 голосов " data-v-544d285f><div class="tm-counter-container__header"><!--[--><div class="karma-display positive" data-v-544d285f data-v-3881f4ba>13</div><!----><!--]--></div><div class="tm-counter-container__footer"><!--[--><div class="karma-text" data-v-544d285f>Карма</div><!--teleport start--><!--teleport end--><!--]--></div></div><div class="tm-counter-container"><div class="tm-counter-container__header"><!--[--><!--[--><!--]--><div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-rating"><!----><div class="tm-votes-lever__score tm-votes-lever__score_appearance-rating tm-votes-lever__score" data-test-id="lever-score"><!--[--><span><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter_rating tm-votes-lever__score-counter" data-test-id="votes-score-counter">0</span></span><!--]--></div><!----></div><!--]--></div><div class="tm-counter-container__footer"><!--[--><span class="tm-rating__text tm-rating__text">Общий рейтинг</span><!--]--></div></div></div></div></div><div class="tm-user-card__info tm-user-card__info_variant-article tm-user-card__info"><div class="tm-user-card__title tm-user-card__title_variant-article tm-user-card__title"><!----><a href="/ru/users/abrca/" class="tm-user-card__nickname tm-user-card__nickname tm-user-card__nickname_variant-article"><!--[-->@abrca<!--]--></a><!----></div><p class="tm-user-card__short-info tm-user-card__short-info_variant-article tm-user-card__short-info" data-test-id="user-card-speciality">Пользователь</p></div></div><!----><div class="tm-user-card__buttons tm-user-card__buttons_variant-article tm-user-card__buttons"><!----><div class="tm-user-card__button"><div class="tm-button-follow tm-user-card__button-follow"><!----><button class="tm-button-follow__button tm-button-follow__button_big" data-test-id="follow-button" type="button">Подписаться</button></div></div><!----><!--[--><div class="tm-user-card__button tm-user-card__button_write" data-test-id="user-card-conversations"><svg class="tm-svg-img tm-user-card__button-icon" height="16" width="16"><title>Отправить сообщение</title><use xlink:href="/img/megazord-v28.cba4c116..svg#mail"></use></svg></div><!--]--><!----><!----></div><!----></div><div class="author-contacts" data-test-id="author-contacts" data-v-af0d0f90><!----><!----><!----></div></div><!--]--></div><!--]--><!----></section><!----><!--[--><div class="sponsor-block" style="--d75346b8:0;--11dbf66e:100%;" data-v-580b3119><div class="title" data-v-580b3119>Хабр доступен 24/7 благодаря поддержке друзей</div><div class="content-container" data-v-580b3119><div class="content" data-v-580b3119><div class="content-title-container" data-v-580b3119><div class="content-title" data-v-580b3119>Хабр Курсы для всех</div><div class="sponsor-mark" data-v-580b3119>РЕКЛАМА</div></div><div class="content-text" data-v-580b3119> Практикум, Хекслет, SkyPro, авторские курсы — собрали всех и попросили скидки. Осталось выбрать! </div><a class="content-action" href="https://career.habr.com/courses/?erid=2VSb5wDLYUH&amp;utm_source=habr&amp;utm_medium=sponsorship_hub" target="_blank" data-v-580b3119><button class="btn btn_solid btn_small tm-button_color-horizon" tabindex="0" type="button" data-v-580b3119><!--[--><!--[-->Перейти<!--]--><!--]--></button></a></div></div><div class="footer" data-v-580b3119><!----></div><!----></div><!--]--><!--]--><div class="tm-article-blocks__comments"><div id="publication-comments" class="tm-article-page-comments"><div><!--[--><div class="article-comments-counter-link-wrapper tm-article-comments-counter-button" data-v-8d952463><a href="/ru/articles/312936/comments/" class="article-comments-counter-link button-style" data-test-id="counter-comments" data-v-8d952463><!--[--><svg class="tm-svg-img icon icon--contrasted" height="24" width="24" data-v-8d952463><title>Комментарии</title><use xlink:href="/img/megazord-v28.cba4c116..svg#counter-comments"></use></svg><span class="value value--contrasted" data-v-8d952463> Комментарии 3 </span><!--]--></a><!----></div><!--]--></div></div></div><!--[--><!--[--><!--]--><section class="tm-block tm-block tm-block_spacing-bottom"><header class="tm-block__header tm-block__header tm-block__header_variant-borderless"><div class="tm-block__header-container"><h2 class="tm-block__title tm-block__title tm-block__title_variant-large">Публикации</h2><!--[--><!--]--></div><!----></header><!--[--><div class="tm-block__body tm-block__body tm-block__body_variant-condensed-slim"><!--[--><!--[--><div class="tabs" data-test-id="container" data-v-681e7545><div class="" data-test-id="scroll-area" data-v-681e7545><!--[--><span class="tab-item" data-v-681e7545><button class="active slim tab-link" data-v-681e7545>Лучшие за сутки</button></span><span class="tab-item" data-v-681e7545><button class="slim tab-link" data-v-681e7545>Похожие</button></span><!--]--></div><!----></div><div class="similar-and-daily__tab-view"><div class="daily-articles-list"><ul class="article-card-list" data-v-7f7081d6><!--[--><!--]--><div class="tm-bordered-card" data-v-7f7081d6><!----><!--[--><!--]--></div></ul><div class="daily-articles-block__button-container"><button class="btn btn_transparent btn_small tm-button_color-horizon" tabindex="0" type="button"><!--[--><!--[-->Показать лучшие за всё время<!--]--><!--]--></button></div></div><!----></div><!--]--><!--]--></div><!--]--><!----></section><!--[--><div><div class="placeholder-wrapper"><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><div class="tm-placeholder-promo"><div class="tm-placeholder-promo__header"><div class="tm-placeholder__line tm-placeholder__line_promo-title"></div></div><div class="tm-placeholder-promo__body"><div class="tm-placeholder-promo__posts"><div class="tm-placeholder-promo__post"><div class="tm-placeholder-promo__image"></div><div class="tm-placeholder__line tm-placeholder__line_post-title"></div></div><div class="tm-placeholder-promo__post"><div class="tm-placeholder-promo__image"></div><div class="tm-placeholder__line tm-placeholder__line_post-title"></div></div><div class="tm-placeholder-promo__post"><div class="tm-placeholder-promo__image"></div><div class="tm-placeholder__line tm-placeholder__line_post-title"></div></div></div><div class="tm-placeholder-promo__dots"><div class="tm-placeholder-promo__dot"></div><div class="tm-placeholder-promo__dot"></div><div class="tm-placeholder-promo__dot"></div></div></div></div><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----></div></div><div class="placeholder-wrapper"><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><div class="tm-placeholder-inset tm-placeholder-vacancies"><div class="tm-placeholder-inset__header"><div class="tm-placeholder__line tm-placeholder__line_inset-header loads"></div></div><div class="tm-placeholder-inset__body"><ul class="tm-placeholder-list"><!--[--><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><!--]--></ul></div><div class="tm-placeholder-inset__footer"><div class="tm-placeholder__line tm-placeholder__line_inset-footer loads"></div></div></div><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----></div><!--]--><!----><!--[--><!--]--><!--]--></div><!----><!--]--><!--]--></div></div><!--]--></div><!--]--></div></div><div class="tm-page__sidebar"><!--[--><div class="sidebar" data-v-0050f56d><div id="sidebar-window-placement" data-v-0050f56d></div><!--[--><!--]--></div><!--]--></div></div><!--]--></div><!----></div></main><!----></div><div class="tm-footer-menu"><div class="tm-page-width"><!--[--><div class="tm-footer-menu__container"><!--[--><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">Ваш аккаунт</p><div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><!--[--><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/articles/312936/&amp;hl=ru" rel="nofollow" target="_self">Войти</a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/articles/312936/&amp;hl=ru" rel="nofollow" target="_self">Регистрация</a></li><!--]--></ul></div></div><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">Разделы</p><div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><!--[--><li class="tm-footer-menu__list-item"><a href="/ru/articles/" class="footer-menu__item-link">Статьи</a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">Новости</a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">Хабы</a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">Компании</a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">Авторы</a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">Песочница</a></li><!--]--></ul></div></div><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">Информация</p><div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><!--[--><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">Устройство сайта</a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">Для авторов</a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">Для компаний</a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">Документы</a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement/?hl=ru_RU" target="_blank">Соглашение</a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/?hl=ru_RU" target="_blank">Конфиденциальность</a></li><!--]--></ul></div></div><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">Услуги</p><div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><!--[--><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/corporate-blogs/" target="_blank">Корпоративный блог</a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/advertising/" target="_blank">Медийная реклама</a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/native-special/" target="_blank">Нативные проекты</a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/education-programs/" target="_blank">Образовательные программы</a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/hello-startup/" target="_blank">Стартапам</a></li><!--]--></ul></div></div><!--]--></div><!--]--></div></div><div class="tm-footer"><div class="tm-page-width"><!--[--><div class="tm-footer__container"><!----><div class="social-icons tm-footer__social" data-v-d6e8cb42><!--[--><a class="tm-svg-icon__wrapper social-icon" href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" data-v-d6e8cb42><svg class="tm-svg-img tm-svg-icon" height="36" width="36"><title>VK</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-vk"></use></svg></a><a class="tm-svg-icon__wrapper social-icon" href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" data-v-d6e8cb42><svg class="tm-svg-img tm-svg-icon" height="36" width="36"><title>Telegram</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a class="tm-svg-icon__wrapper social-icon" href="http://www.youtube.com/@Habr_com" rel="nofollow noopener noreferrer" target="_blank" data-v-d6e8cb42><svg class="tm-svg-img tm-svg-icon" height="36" width="36"><title>Youtube</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a class="tm-svg-icon__wrapper social-icon" href="https://dzen.ru/habr" rel="nofollow noopener noreferrer" target="_blank" data-v-d6e8cb42><svg class="tm-svg-img tm-svg-icon" height="36" width="36"><title>Яндекс Дзен</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-dzen"></use></svg></a><!--]--></div><!--teleport start--><!--teleport end--><button class="tm-footer__link"><!----> Настройка языка</button><a href="/ru/feedback/" class="tm-footer__link">Техническая поддержка</a><div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2026,</span><span class="tm-copyright__name"><a class="tm-copyright__link" href="https://company.habr.com/" rel="noopener" target="_blank"> Habr </a></span></span></div></div><!--]--></div></div><!----><!----><!--]--></div><!----></div></div>
    <div id="overlays"><!--teleport start anchor--><template><!----></template><!--teleport anchor--><!--teleport start anchor--><template><!----></template><!--teleport anchor--><!--teleport start anchor--><template><!----></template><!----><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor--></div>
    
    
    
    
  
  
    
  
    </body>

    </html>
